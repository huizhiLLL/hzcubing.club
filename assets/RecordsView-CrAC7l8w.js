import{_ as ce}from"./refresh-DSDc0Cm4.js";import{_ as ae,a as ne,u as oe,r as R,c as A,o as re,E as G,j as h,k as ie,l as t,m as d,y as ee,z as k,p as n,n as v,x as f,t as c,s as E,b as se,q as e,v as y,e as X,w as le,i as ve,F as U,A as L,D as me,G as q}from"./index-BHRzxtpC.js";import{E as Z}from"./ElementTransition-C-ObTZXC.js";const _e={class:"table-container"},fe={key:1},ge={class:"record-cell"},pe={key:0,class:"record-value"},ke={key:0,class:"rank"},ye={key:1},we={key:2,class:"holder-nickname"},be={key:1},he={class:"record-cell"},$e={key:0,class:"record-value"},Se={key:0,class:"rank"},Re={key:1},Ie={key:2,class:"holder-nickname"},He={key:1},Te={key:1},Ne={key:0,class:"record-details glass-form"},Ve={class:"detail-item"},Ue={class:"value"},Be={class:"detail-item"},De={class:"value"},Ee={key:0,class:"detail-item"},xe={class:"value"},ze={key:1},Ae={key:1,class:"detail-item"},Ce={class:"value"},Fe={key:2,class:"detail-item"},Me={class:"value"},Le={class:"detail-item"},Ge={class:"value"},Oe={key:3,class:"detail-item"},je={class:"value"},Pe={key:1},Ye={key:4,class:"detail-item"},qe={class:"value"},We={key:5,class:"detail-item"},Je=["href"],Ke={key:6,class:"detail-item"},Qe={class:"value"},Xe={key:7,class:"actions"},Ze={class:"dialog-footer"},et={__name:"RecordsTable",props:{records:{type:Array,default:()=>[]},showActions:{type:Boolean,default:!0},autoRefresh:{type:Boolean,default:!0},isDebug:{type:Boolean,default:!1}},emits:["refresh","delete"],setup(te,{emit:W}){const b=te,C=W,T=ne(),I=oe(),S=R(!1),N=R(!1),B=R(!1),$=R(!1),r=R(null),O=i=>{var s,_;return i.cube||((s=i.single)==null?void 0:s.cube)||((_=i.average)==null?void 0:_.cube)||""},j=i=>{var s,_;return i.method||((s=i.single)==null?void 0:s.method)||((_=i.average)==null?void 0:_.method)||""},F=i=>i!=null&&i!=="null"&&i!=="",x=i=>T.formatTime(i),J=(i,s=!1)=>{if(!i)return"-";const _=new Date(i);if(isNaN(_))return"-";const u=_.getFullYear(),g=String(_.getMonth()+1).padStart(2,"0"),w=String(_.getDate()).padStart(2,"0");let p=`${u}.${g}.${w}`;if(s){const H=String(_.getHours()).padStart(2,"0"),o=String(_.getMinutes()).padStart(2,"0");p+=` ${H}:${o}`}return p},z=A(()=>b.records),M=async()=>{if(b.autoRefresh){S.value=!0;try{await T.fetchRecords(),C("refresh")}catch{G.error("刷新数据失败")}finally{S.value=!1}}else C("refresh")},K=i=>!I.user||!i?!1:(i.userId||i.userId)&&i.userId===I.user._id,m=()=>{$.value=!0},a=async()=>{if(!r.value||!r.value._id){G.error("无法删除，记录ID不存在"),$.value=!1;return}N.value=!0;try{await T.deleteRecord(r.value._id),G.success("记录已删除"),$.value=!1,B.value=!1,C("delete",r.value._id),M()}catch(i){G.error("删除失败: "+i.message)}finally{N.value=!1}};return re(()=>{b.autoRefresh&&M()}),(i,s)=>{const _=h("el-table-column"),u=h("router-link"),g=h("el-table"),w=h("el-button"),p=h("el-dialog"),H=ie("loading");return t(),d("div",_e,[ee((t(),k(g,{data:z.value,style:{width:"100%"},stripe:!0,class:"records-table glass-table"},{default:n(()=>[v(_,{label:"项目","min-width":"100"},{default:n(o=>[f(c(E(se)(o.row.event)),1)]),_:1}),v(_,{label:"昵称","min-width":"120","class-name":"nickname-column"},{default:n(o=>[o.row.singleHolderUserId?(t(),k(u,{key:0,to:`/user/${o.row.singleHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(c(o.row.singleHolderNickname||"-"),1)]),_:2},1032,["to"])):(t(),d("span",fe,c(o.row.singleHolderNickname||"-"),1))]),_:1}),v(_,{label:"单次","min-width":"100"},{default:n(o=>[e("div",ge,[o.row.singleSeconds!==void 0?(t(),d("span",pe,[f(c(x(o.row.singleSeconds))+" ",1),o.row.singleRank?(t(),d("span",ke,"(#"+c(o.row.singleRank)+")",1)):y("",!0)])):(t(),d("span",ye,"-")),o.row.singleHolderNickname?(t(),d("span",we,[o.row.singleHolderUserId?(t(),k(u,{key:0,to:`/user/${o.row.singleHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(c(o.row.singleHolderNickname),1)]),_:2},1032,["to"])):(t(),d("span",be,c(o.row.singleHolderNickname),1))])):y("",!0)])]),_:1}),v(_,{label:"平均","min-width":"100"},{default:n(o=>[e("div",he,[o.row.averageSeconds!==void 0?(t(),d("span",$e,[f(c(x(o.row.averageSeconds))+" ",1),o.row.averageRank?(t(),d("span",Se,"(#"+c(o.row.averageRank)+")",1)):y("",!0)])):(t(),d("span",Re,"-")),o.row.averageHolderNickname?(t(),d("span",Ie,[o.row.averageHolderUserId?(t(),k(u,{key:0,to:`/user/${o.row.averageHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(c(o.row.averageHolderNickname),1)]),_:2},1032,["to"])):(t(),d("span",He,c(o.row.averageHolderNickname),1))])):y("",!0)])]),_:1}),v(_,{label:"昵称","min-width":"120","class-name":"nickname-column"},{default:n(o=>[o.row.averageHolderUserId?(t(),k(u,{key:0,to:`/user/${o.row.averageHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(c(o.row.averageHolderNickname||"-"),1)]),_:2},1032,["to"])):(t(),d("span",Te,c(o.row.averageHolderNickname||"-"),1))]),_:1})]),_:1},8,["data"])),[[H,S.value]]),v(p,{modelValue:B.value,"onUpdate:modelValue":s[0]||(s[0]=o=>B.value=o),title:"成绩详情",width:"500px",class:"glass-dialog"},{default:n(()=>[r.value?(t(),d("div",Ne,[e("div",Ve,[s[3]||(s[3]=e("span",{class:"label"},"项目:",-1)),e("span",Ue,c(E(se)(r.value.event)),1)]),e("div",Be,[s[4]||(s[4]=e("span",{class:"label"},"单次成绩:",-1)),e("span",De,c(r.value.singleSeconds?x(r.value.singleSeconds):"-"),1)]),r.value.singleHolderUserId||r.value.singleHolderNickname?(t(),d("div",Ee,[s[5]||(s[5]=e("span",{class:"label"},"单次保持者:",-1)),e("span",xe,[r.value.singleHolderUserId?(t(),k(u,{key:0,to:`/user/${r.value.singleHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(c(r.value.singleHolderNickname||"-"),1)]),_:1},8,["to"])):(t(),d("span",ze,c(r.value.singleHolderNickname||"-"),1))])])):y("",!0),F(O(r.value))?(t(),d("div",Ae,[s[6]||(s[6]=e("span",{class:"label"},"使用魔方:",-1)),e("span",Ce,c(O(r.value)),1)])):y("",!0),F(j(r.value))?(t(),d("div",Fe,[s[7]||(s[7]=e("span",{class:"label"},"使用方法:",-1)),e("span",Me,c(j(r.value)),1)])):y("",!0),e("div",Le,[s[8]||(s[8]=e("span",{class:"label"},"平均成绩:",-1)),e("span",Ge,c(r.value.averageSeconds!==void 0?x(r.value.averageSeconds):"-"),1)]),r.value.averageHolderUserId||r.value.averageHolderNickname?(t(),d("div",Oe,[s[9]||(s[9]=e("span",{class:"label"},"平均保持者:",-1)),e("span",je,[r.value.averageHolderUserId?(t(),k(u,{key:0,to:`/user/${r.value.averageHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(c(r.value.averageHolderNickname||"-"),1)]),_:1},8,["to"])):(t(),d("span",Pe,c(r.value.averageHolderNickname||"-"),1))])])):y("",!0),F(r.value.remark)?(t(),d("div",Ye,[s[10]||(s[10]=e("span",{class:"label"},"备注:",-1)),e("span",qe,c(r.value.remark),1)])):y("",!0),r.value.videoLink?(t(),d("div",We,[s[11]||(s[11]=e("span",{class:"label"},"视频链接:",-1)),e("a",{href:r.value.videoLink,target:"_blank",class:"video-link"},c(r.value.videoLink),9,Je)])):y("",!0),r.value.timestamp?(t(),d("div",Ke,[s[12]||(s[12]=e("span",{class:"label"},"提交时间:",-1)),e("span",Qe,c(J(r.value.timestamp,!0)),1)])):y("",!0),K(r.value)?(t(),d("div",Xe,[v(w,{type:"danger",size:"small",onClick:m},{default:n(()=>s[13]||(s[13]=[f("删除")])),_:1})])):y("",!0)])):y("",!0)]),_:1},8,["modelValue"]),v(p,{modelValue:$.value,"onUpdate:modelValue":s[2]||(s[2]=o=>$.value=o),title:"确认删除",width:"300px",class:"glass-dialog"},{footer:n(()=>[e("span",Ze,[v(w,{onClick:s[1]||(s[1]=o=>$.value=!1)},{default:n(()=>s[14]||(s[14]=[f("取消")])),_:1}),v(w,{type:"danger",onClick:a,loading:N.value},{default:n(()=>s[15]||(s[15]=[f("确定")])),_:1},8,["loading"])])]),default:n(()=>[s[16]||(s[16]=e("p",null,"确定要删除这条成绩记录吗？此操作不可恢复。",-1))]),_:1},8,["modelValue"])])}}},tt=ae(et,[["__scopeId","data-v-68e17ab1"]]),st={class:"records-container"},lt={class:"page-header glass-header"},at={class:"title-with-refresh"},nt={key:0,src:ce,alt:"刷新",class:"refresh-icon"},ot={key:1,class:"el-icon-loading"},rt={class:"header-actions"},it={key:0,class:"error-alert"},dt={class:"card glass-card"},ut={class:"filter-header"},ct={class:"filter-controls"},vt={class:"table-responsive"},mt={class:"card glass-card"},_t={class:"filter-header"},ft={class:"filter-controls"},gt={key:0,class:"table-responsive"},pt={class:"record-details"},kt={class:"detail-item"},yt={class:"detail-value"},wt={class:"detail-item"},bt={class:"detail-value"},ht={class:"detail-item"},$t={class:"detail-value"},St={class:"detail-item"},Rt={class:"detail-value"},It={class:"detail-item"},Ht={class:"detail-value"},Tt={class:"record-cell"},Nt={class:"record-main"},Vt={class:"record-sub"},Ut={class:"record-cell"},Bt={class:"record-main"},Dt={class:"record-sub"},Et={class:"pagination"},xt={__name:"RecordsView",setup(te){const W=oe(),b=ne(),{user:C}=W,T=R("official"),I=R("official_all"),S=R("333"),N=R(1),B=R(10),$=R(!1),r=R(""),O=async()=>{$.value=!0,r.value="";try{await b.fetchRecords(),G.success("数据刷新成功")}catch(m){console.error("刷新记录失败:",m),r.value=m.message||"获取数据失败，请稍后再试"}finally{$.value=!1}};re(async()=>{$.value=!0,r.value="";try{await b.fetchRecords();const m=b.getRecordsByEvent(S.value);await b.ensureNicknamesForRecords(m)}catch(m){console.error("获取记录失败:",m),r.value=m.message||"获取数据失败，请稍后再试"}finally{$.value=!1}});const j=A(()=>T.value==="all"?[X.all]:T.value?[X[T.value]]:[]);le(T,m=>{I.value=m?`${m}_all`:""});const F=A(()=>{var a;const m=b.getBestRecords();if(I.value==="all_all")return Object.values(m);if(I.value.endsWith("_all")){const i=I.value.split("_")[0],_=(((a=X[i])==null?void 0:a.options)||[]).slice(1).map(u=>u.value);return Object.values(m).filter(u=>_.includes(u.event))}return[m[I.value]].filter(Boolean)}),x=A(()=>{if(!S.value)return[];const m=b.getRecordsByEvent(S.value),a=[];let i=1/0,s=1/0;return[...m].sort((u,g)=>{var H,o,D,P;const w=u.timestamp?new Date(u.timestamp).getTime():0,p=g.timestamp?new Date(g.timestamp).getTime():0;if(w===p){const Q=(H=u.single)!=null&&H.time?b.convertToSeconds(u.single.time):1/0,Y=(o=g.single)!=null&&o.time?b.convertToSeconds(g.single.time):1/0,l=(D=u.average)!=null&&D.time?b.convertToSeconds(u.average.time):1/0,V=(P=g.average)!=null&&P.time?b.convertToSeconds(g.average.time):1/0,de=Math.min(Q,l),ue=Math.min(Y,V);return de-ue}return w-p}).forEach(u=>{let g=!1;const w=typeof u.singleSeconds=="number"?u.singleSeconds:null,p=typeof u.averageSeconds=="number"?u.averageSeconds:null;w!==null&&w<i&&(i=w,g=!0),p!==null&&p<s&&(s=p,g=!0),g&&a.push({...u,isSingleRecord:w!==null&&w===i,isAverageRecord:p!==null&&p===s,nickname:u.nickname||b.getNicknameForUser(u.userId)||""})}),a.reverse(),a.slice((N.value-1)*B.value,N.value*B.value)}),J=A(()=>{if(!S.value)return 0;const m=b.getRecordsByEvent(S.value);let a=1/0,i=1/0,s=0;return[...m].sort((u,g)=>{const w=u.timestamp?new Date(u.timestamp).getTime():0,p=g.timestamp?new Date(g.timestamp).getTime():0;return w-p}).forEach(u=>{let g=!1;const w=typeof u.singleSeconds=="number"?u.singleSeconds:null,p=typeof u.averageSeconds=="number"?u.averageSeconds:null;w!==null&&w<a&&(a=w,g=!0),p!==null&&p<i&&(i=p,g=!0),g&&s++}),s});le(S,()=>{N.value=1;const m=b.getRecordsByEvent(S.value);b.ensureNicknamesForRecords(m)});const z=m=>b.formatTime(m),M=m=>{if(!m)return"-";const a=new Date(m),i=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),_=String(a.getDate()).padStart(2,"0");return`${i}.${s}.${_}`},K=A(()=>ve());return(m,a)=>{const i=h("el-button"),s=h("router-link"),_=h("el-alert"),u=h("el-option"),g=h("el-select"),w=h("el-option-group"),p=h("el-tag"),H=h("el-icon"),o=h("el-tooltip"),D=h("el-table-column"),P=h("el-table"),Q=h("el-pagination"),Y=ie("loading");return t(),d("div",st,[v(Z,{name:"fade",duration:600,appear:""},{default:n(()=>[e("div",lt,[e("div",at,[a[6]||(a[6]=e("h1",{class:"page-title"},"记录统计",-1)),v(i,{circle:"",plain:"",size:"small",type:"info",onClick:O,loading:$.value,class:"refresh-icon-button"},{default:n(()=>[$.value?(t(),d("i",ot)):(t(),d("img",nt))]),_:1},8,["loading"])]),e("div",rt,[E(C)?(t(),k(s,{key:0,to:"/submit-record"},{default:n(()=>[v(i,{type:"primary"},{default:n(()=>a[7]||(a[7]=[f("上传成绩")])),_:1})]),_:1})):y("",!0)])])]),_:1}),r.value?(t(),d("div",it,[v(_,{title:"获取数据失败",type:"error",description:r.value,"show-icon":"",closable:"",onClose:a[0]||(a[0]=l=>r.value="")},null,8,["description"])])):y("",!0),v(Z,{name:"slide-up",duration:600,delay:200,appear:""},{default:n(()=>[ee((t(),d("div",dt,[e("div",ut,[a[8]||(a[8]=e("h2",{class:"section-title"},"最佳记录",-1)),e("div",ct,[v(g,{modelValue:T.value,"onUpdate:modelValue":a[1]||(a[1]=l=>T.value=l),placeholder:"选择项目类型",class:"category-select glass-select"},{default:n(()=>[(t(!0),d(U,null,L(E(me),l=>(t(),k(u,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),v(g,{modelValue:I.value,"onUpdate:modelValue":a[2]||(a[2]=l=>I.value=l),placeholder:"选择具体项目",class:"event-select glass-select",loading:$.value},{default:n(()=>[(t(!0),d(U,null,L(j.value,l=>(t(),k(w,{key:l.label,label:l.label},{default:n(()=>[(t(!0),d(U,null,L(l.options,V=>(t(),k(u,{key:V.value,label:V.label,value:V.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","loading"])])]),e("div",vt,[v(tt,{records:F.value},null,8,["records"])])])),[[Y,$.value]])]),_:1}),v(Z,{name:"slide-up",duration:600,delay:400,appear:""},{default:n(()=>[ee((t(),d("div",mt,[e("div",_t,[a[9]||(a[9]=e("h2",{class:"section-title"},"历史记录",-1)),e("div",ft,[v(g,{modelValue:S.value,"onUpdate:modelValue":a[3]||(a[3]=l=>S.value=l),placeholder:"选择项目",class:"event-select glass-select"},{default:n(()=>[(t(!0),d(U,null,L(K.value,l=>(t(),k(w,{key:l.label,label:l.label},{default:n(()=>[(t(!0),d(U,null,L(l.options,V=>(t(),k(u,{key:V.value,label:V.label,value:V.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])]),S.value?(t(),d("div",gt,[v(P,{data:x.value,style:{width:"100%"},stripe:!0,class:"custom-table glass-table"},{default:n(()=>[v(D,{type:"expand"},{default:n(l=>[e("div",pt,[e("div",kt,[a[11]||(a[11]=e("span",{class:"detail-label"},"单次成绩：",-1)),e("span",yt,[f(c(z(l.row.singleSeconds))+" ",1),l.row.isSingleRecord?(t(),k(p,{key:0,size:"small",type:"danger",effect:"dark"},{default:n(()=>a[10]||(a[10]=[f("GR")])),_:1})):y("",!0)])]),e("div",wt,[a[12]||(a[12]=e("span",{class:"detail-label"},"单次保持者：",-1)),e("span",bt,[l.row.userId?(t(),k(s,{key:0,to:`/user/${l.row.userId}`,class:"player-link"},{default:n(()=>[f(c(l.row.nickname||"未知"),1)]),_:2},1032,["to"])):(t(),d(U,{key:1},[e("span",null,c(l.row.nickname||"-"),1),l.row.nickname?(t(),k(o,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:n(()=>[v(H,{class:"info-icon"},{default:n(()=>[v(E(q))]),_:1})]),_:1})):y("",!0)],64))])]),e("div",ht,[a[14]||(a[14]=e("span",{class:"detail-label"},"平均成绩：",-1)),e("span",$t,[f(c(z(l.row.averageSeconds))+" ",1),l.row.isAverageRecord?(t(),k(p,{key:0,size:"small",type:"danger",effect:"dark"},{default:n(()=>a[13]||(a[13]=[f("GR")])),_:1})):y("",!0)])]),e("div",St,[a[15]||(a[15]=e("span",{class:"detail-label"},"平均保持者：",-1)),e("span",Rt,[l.row.userId?(t(),k(s,{key:0,to:`/user/${l.row.userId}`,class:"player-link"},{default:n(()=>[f(c(l.row.nickname||"未知"),1)]),_:2},1032,["to"])):(t(),d(U,{key:1},[e("span",null,c(l.row.nickname||"-"),1),l.row.nickname?(t(),k(o,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:n(()=>[v(H,{class:"info-icon"},{default:n(()=>[v(E(q))]),_:1})]),_:1})):y("",!0)],64))])]),e("div",It,[a[16]||(a[16]=e("span",{class:"detail-label"},"记录时间：",-1)),e("span",Ht,c(M(l.row.timestamp)),1)])])]),_:1}),v(D,{prop:"index",label:"序号","min-width":"60",type:"index",index:1}),v(D,{label:"单次","min-width":"160"},{default:n(l=>[e("div",Tt,[e("div",Nt,[f(c(z(l.row.singleSeconds))+" ",1),l.row.isSingleRecord?(t(),k(p,{key:0,size:"small",type:"danger",effect:"dark"},{default:n(()=>a[17]||(a[17]=[f("GR")])),_:1})):y("",!0)]),e("div",Vt,[l.row.userId?(t(),k(s,{key:0,to:`/user/${l.row.userId}`,class:"player-link"},{default:n(()=>[f(c(l.row.nickname||"未知"),1)]),_:2},1032,["to"])):(t(),d(U,{key:1},[e("span",null,c(l.row.nickname||"-"),1),l.row.nickname?(t(),k(o,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:n(()=>[v(H,{class:"info-icon"},{default:n(()=>[v(E(q))]),_:1})]),_:1})):y("",!0)],64))])])]),_:1}),v(D,{label:"平均","min-width":"160"},{default:n(l=>[e("div",Ut,[e("div",Bt,[f(c(z(l.row.averageSeconds))+" ",1),l.row.isAverageRecord?(t(),k(p,{key:0,size:"small",type:"danger",effect:"dark"},{default:n(()=>a[18]||(a[18]=[f("GR")])),_:1})):y("",!0)]),e("div",Dt,[l.row.userId?(t(),k(s,{key:0,to:`/user/${l.row.userId}`,class:"player-link"},{default:n(()=>[f(c(l.row.nickname||"未知"),1)]),_:2},1032,["to"])):(t(),d(U,{key:1},[e("span",null,c(l.row.nickname||"-"),1),l.row.nickname?(t(),k(o,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:n(()=>[v(H,{class:"info-icon"},{default:n(()=>[v(E(q))]),_:1})]),_:1})):y("",!0)],64))])])]),_:1}),v(D,{prop:"timestamp",label:"时间","min-width":"120","class-name":"hide-on-mobile"},{default:n(l=>[f(c(M(l.row.timestamp)),1)]),_:1})]),_:1},8,["data"]),e("div",Et,[v(Q,{"current-page":N.value,"onUpdate:currentPage":a[4]||(a[4]=l=>N.value=l),"page-size":B.value,"onUpdate:pageSize":a[5]||(a[5]=l=>B.value=l),total:J.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",class:"responsive-pagination"},null,8,["current-page","page-size","total"])])])):y("",!0)])),[[Y,$.value]])]),_:1})])}}},Ft=ae(xt,[["__scopeId","data-v-0ce70987"]]);export{Ft as default};
