import{_ as ie,r,o as ue,u as G,w as K,j as u,l as i,m as f,q as t,n as l,p as a,t as m,s as k,O as de,a2 as ce,x as p,z as F,F as M,A as P,H as me,R as pe,v as Q,L as ve,E as b,Z as fe,C as _e,N as ye,a3 as be}from"./index-BHRzxtpC.js";const ge={class:"online-competition"},he={class:"competition-container"},we={class:"competition-content"},Ne={class:"event-info"},ke={class:"event-title"},Ve={class:"results-table"},Ce={class:"card-header"},Se={class:"header-actions"},Ee={class:"table-container"},Ue={key:0,class:"loading-container"},Te={key:1,class:"error-container"},je={class:"rank-number"},Oe=["title"],xe={class:"average-time"},ze={class:"single-time"},De={class:"scores-container"},Fe={key:2,class:"no-permission"},Re={class:"scores-input"},Ie={class:"score-label"},$e={class:"dialog-footer"},qe={class:"scores-input"},Be={class:"score-label"},Me={class:"dialog-footer"},Pe={__name:"OnlineCompetition",setup(Ae){const d=r("333"),T=r([]),R=r(!1),V=r(""),I=r(!1),X=r(1),A=()=>{I.value=window.innerWidth<=768},j=r(!1),C=r(!1),S=r(!1),g=r(!1),$=r(),q=r(),_=r({playerName:"",scores:["","","","",""]}),v=r({playerId:"",playerName:"",scores:["","","","",""]}),J={playerName:[{required:!0,message:"请输入选手姓名",trigger:"blur"}],scores:[{required:!0,message:"请输入五次成绩",trigger:"blur"}]},Y=s=>{d.value=s,O()},B=s=>({333:"三阶",222:"二阶","333oh":"三单",444:"四阶"})[s]||"未知项目",O=async()=>{R.value=!0,V.value="";try{const s=await fetch("https://w3mavh11ex.bja.sealos.run/online-match",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:d.value,action:"getResults"})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const e=await s.json();e.success?T.value=e.results||[]:(console.error("获取比赛结果失败:",e.message),V.value=e.message||"获取数据失败",T.value=[])}catch(s){console.error("获取比赛结果失败:",s),V.value="网络错误，请稍后重试",T.value=[]}finally{R.value=!1}},E=()=>{O()},L=()=>{const s=x(),e=["3169164181@qq.com","3679063384@qq.com"];j.value=e.includes(s)},x=()=>{var e;return((e=G().user)==null?void 0:e.email)||""},ee=()=>{_.value={playerName:"",scores:["","","","",""]},C.value=!0},le=async()=>{if($.value)try{await $.value.validate(),g.value=!0;const s=x(),c=await(await fetch("https://w3mavh11ex.bja.sealos.run/online-match",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:d.value,action:"addScore",playerName:_.value.playerName,scores:_.value.scores,email:s})})).json();c.success?(b.success("成绩录入成功"),C.value=!1,E()):b.error(c.message||"录入失败")}catch(s){console.error("录入成绩失败:",s),b.error("录入失败，请重试")}finally{g.value=!1}},ae=s=>{v.value={playerId:s.playerId||s._id,playerName:s.playerName,scores:s.rawScores||s.scores.map(e=>e.value)},S.value=!0},se=async()=>{if(q.value)try{await q.value.validate(),g.value=!0;const s=x(),c=await(await fetch("https://w3mavh11ex.bja.sealos.run/online-match",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:d.value,action:"updateScore",playerId:v.value.playerId,playerName:v.value.playerName,scores:v.value.scores,email:s})})).json();c.success?(b.success("成绩更新成功"),S.value=!1,E()):b.error(c.message||"更新失败")}catch(s){console.error("更新成绩失败:",s),b.error("更新失败，请重试")}finally{g.value=!1}},te=async s=>{try{await ve.confirm(`确定要删除选手 ${s.playerName} 的成绩吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=x(),z=await(await fetch("https://w3mavh11ex.bja.sealos.run/online-match",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:d.value,action:"deleteScore",playerId:s.playerId||s._id,email:e})})).json();z.success?(b.success("删除成功"),E()):b.error(z.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除成绩失败:",e),b.error("删除失败，请重试"))}};ue(()=>{O(),L(),A(),window.addEventListener("resize",A)}),K(d,()=>{O()});const oe=G();return K(()=>oe.user,()=>{L()},{immediate:!0}),(s,e)=>{const c=u("el-tab-pane"),z=u("el-tabs"),h=u("el-icon"),y=u("el-button"),w=u("el-table-column"),ne=u("el-table"),re=u("el-card"),D=u("el-input"),N=u("el-form-item"),H=u("el-tag"),Z=u("el-form"),W=u("el-dialog");return i(),f("div",ge,[e[22]||(e[22]=t("div",{class:"page-header"},[t("h1",{class:"page-title"},"2025会枝杯夏季线上赛")],-1)),t("div",he,[l(z,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=o=>d.value=o),class:"event-tabs",onTabChange:Y},{default:a(()=>[l(c,{label:"三阶",name:"333"},{label:a(()=>e[7]||(e[7]=[t("span",{class:"event-label"},"三阶",-1)])),_:1}),l(c,{label:"二阶",name:"222"},{label:a(()=>e[8]||(e[8]=[t("span",{class:"event-label"},"二阶",-1)])),_:1}),l(c,{label:"三单",name:"333oh"},{label:a(()=>e[9]||(e[9]=[t("span",{class:"event-label"},"三单",-1)])),_:1}),l(c,{label:"四阶",name:"444"},{label:a(()=>e[10]||(e[10]=[t("span",{class:"event-label"},"四阶",-1)])),_:1})]),_:1},8,["modelValue"]),t("div",we,[t("div",Ne,[t("h2",ke,m(B(d.value)),1)]),t("div",Ve,[l(re,{class:"table-card"},{header:a(()=>[t("div",Ce,[e[13]||(e[13]=t("span",null,"成绩排名",-1)),t("div",Se,[j.value?(i(),F(y,{key:0,type:"success",size:"small",onClick:ee},{default:a(()=>[l(h,null,{default:a(()=>[l(k(ye))]),_:1}),e[11]||(e[11]=p(" 录入成绩 "))]),_:1})):Q("",!0),l(y,{type:"primary",size:"small",onClick:E},{default:a(()=>[l(h,null,{default:a(()=>[l(k(be))]),_:1}),e[12]||(e[12]=p(" 刷新 "))]),_:1})])])]),default:a(()=>[t("div",Ee,[R.value?(i(),f("div",Ue,[l(h,{class:"is-loading"},{default:a(()=>[l(k(de))]),_:1}),e[14]||(e[14]=t("span",null,"加载中...",-1))])):V.value?(i(),f("div",Te,[l(h,null,{default:a(()=>[l(k(ce))]),_:1}),t("span",null,m(V.value),1),l(y,{type:"primary",size:"small",onClick:E},{default:a(()=>e[15]||(e[15]=[p("重试")])),_:1})])):(i(),F(ne,{key:2,data:T.value,stripe:"",class:"results-table",style:_e({transform:`scale(${X.value})`,transformOrigin:"top left"})},{default:a(()=>[l(w,{prop:"rank",label:"排名",width:"60",align:"center","class-name":"el-table-column--rank"},{default:a(o=>[t("span",je,m(o.row.rank),1)]),_:1}),l(w,{prop:"playerName",label:"玩家名",width:"120","class-name":"el-table-column--player"},{default:a(o=>[t("span",{class:"player-name",title:o.row.playerName},m(o.row.playerName),9,Oe)]),_:1}),l(w,{prop:"average",label:"平均",width:"90",align:"center","class-name":"el-table-column--average"},{default:a(o=>[t("span",xe,m(o.row.average),1)]),_:1}),l(w,{prop:"single",label:"单次",width:"90",align:"center","class-name":"el-table-column--single"},{default:a(o=>[t("span",ze,m(o.row.single),1)]),_:1}),l(w,{prop:"scores",label:"成绩","min-width":"200","class-name":"el-table-column--scores"},{default:a(o=>[t("div",De,[(i(!0),f(M,null,P(o.row.scores,(n,U)=>(i(),f("span",{key:U,class:me(["score-item",{"dropped-score":n.isDropped}])},m(n.isDropped?`(${n.value})`:n.value),3))),128))])]),_:1}),l(w,{label:"操作",width:"150",align:"center","class-name":"el-table-column--actions"},{default:a(o=>[j.value?(i(),F(y,{key:0,type:"primary",size:"small",onClick:n=>ae(o.row)},{default:a(()=>[l(h,null,{default:a(()=>[l(k(pe))]),_:1}),e[16]||(e[16]=p(" 编辑 "))]),_:2},1032,["onClick"])):Q("",!0),j.value?(i(),F(y,{key:1,type:"danger",size:"small",onClick:n=>te(o.row)},{default:a(()=>[l(h,null,{default:a(()=>[l(k(fe))]),_:1}),e[17]||(e[17]=p(" 删除 "))]),_:2},1032,["onClick"])):(i(),f("span",Fe,"仅管理员可操作"))]),_:1})]),_:1},8,["data","style"]))])]),_:1})])])]),l(W,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=o=>C.value=o),title:"录入成绩",width:I.value?"90%":"600px","close-on-click-modal":!1},{footer:a(()=>[t("span",$e,[l(y,{onClick:e[2]||(e[2]=o=>C.value=!1)},{default:a(()=>e[18]||(e[18]=[p("取消")])),_:1}),l(y,{type:"primary",onClick:le,loading:g.value},{default:a(()=>e[19]||(e[19]=[p("确定")])),_:1},8,["loading"])])]),default:a(()=>[l(Z,{model:_.value,rules:J,ref_key:"scoreFormRef",ref:$,"label-width":"100px"},{default:a(()=>[l(N,{label:"选手姓名",prop:"playerName"},{default:a(()=>[l(D,{modelValue:_.value.playerName,"onUpdate:modelValue":e[1]||(e[1]=o=>_.value.playerName=o),placeholder:"请输入选手姓名"},null,8,["modelValue"])]),_:1}),l(N,{label:"项目类型"},{default:a(()=>[l(H,{type:"info",size:"large"},{default:a(()=>[p(m(B(d.value)),1)]),_:1})]),_:1}),l(N,{label:"五次成绩",prop:"scores"},{default:a(()=>[t("div",Re,[(i(!0),f(M,null,P(_.value.scores,(o,n)=>(i(),f("div",{key:n,class:"score-input-item"},[t("span",Ie,"第"+m(n+1)+"次",1),l(D,{modelValue:_.value.scores[n],"onUpdate:modelValue":U=>_.value.scores[n]=U,placeholder:"成绩或DNF/DNS",class:"score-input"},null,8,["modelValue","onUpdate:modelValue"])]))),128))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),l(W,{modelValue:S.value,"onUpdate:modelValue":e[6]||(e[6]=o=>S.value=o),title:"编辑成绩",width:I.value?"90%":"600px","close-on-click-modal":!1},{footer:a(()=>[t("span",Me,[l(y,{onClick:e[5]||(e[5]=o=>S.value=!1)},{default:a(()=>e[20]||(e[20]=[p("取消")])),_:1}),l(y,{type:"primary",onClick:se,loading:g.value},{default:a(()=>e[21]||(e[21]=[p("更新")])),_:1},8,["loading"])])]),default:a(()=>[l(Z,{model:v.value,rules:J,ref_key:"editFormRef",ref:q,"label-width":"100px"},{default:a(()=>[l(N,{label:"选手姓名",prop:"playerName"},{default:a(()=>[l(D,{modelValue:v.value.playerName,"onUpdate:modelValue":e[4]||(e[4]=o=>v.value.playerName=o),placeholder:"请输入选手姓名"},null,8,["modelValue"])]),_:1}),l(N,{label:"项目类型"},{default:a(()=>[l(H,{type:"info",size:"large"},{default:a(()=>[p(m(B(d.value)),1)]),_:1})]),_:1}),l(N,{label:"五次成绩",prop:"scores"},{default:a(()=>[t("div",qe,[(i(!0),f(M,null,P(v.value.scores,(o,n)=>(i(),f("div",{key:n,class:"score-input-item"},[t("span",Be,"第"+m(n+1)+"次",1),l(D,{modelValue:v.value.scores[n],"onUpdate:modelValue":U=>v.value.scores[n]=U,placeholder:"成绩或DNF/DNS",class:"score-input"},null,8,["modelValue","onUpdate:modelValue"])]))),128))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"])])}}},Le=ie(Pe,[["__scopeId","data-v-2a9500e0"]]);export{Le as default};
