import{_ as le}from"./refresh-DSDc0Cm4.js";import{_ as se,b as ae,u as oe,r as g,o as ne,I as re,c as H,e as C,w as ie,j as v,k as de,l as o,m as i,n,p as d,q as s,E as T,v as b,y as ce,F as U,A as z,z as S,s as I,G as ue,x as M,J as A,t as m,K as ve,d as me}from"./index-Bsn6c0zj.js";import{E as J}from"./ElementTransition-DMMnBOwW.js";const _e={class:"leaderboard-container"},pe={class:"page-header glass-header"},fe={class:"title-with-refresh"},ge={key:0,src:le,alt:"刷新",class:"refresh-icon"},be={key:1,class:"el-icon-loading"},ke={key:0,class:"error-alert"},he={class:"card glass-card"},ye={class:"filter-header"},we={class:"filter-controls"},Ve={class:"filter-row"},Se={key:0,class:"table-responsive"},Ee={class:"rank-cell"},Ie={key:0,class:"medal-rank"},$e={key:1,class:"rank-number"},Re={class:"player-cell"},xe={class:"time-cell"},Ce=["onClick"],Me={key:1,class:"no-event-selected"},Ne={key:2,class:"no-event-selected"},De={key:0,class:"record-details glass-form"},Le={class:"detail-item"},Be={class:"value"},Fe={class:"detail-item"},Te={class:"value"},Ue={class:"detail-item"},ze={class:"value"},Ae={key:0,class:"detail-item"},We={class:"value"},je={key:1,class:"detail-item"},Oe={class:"value"},qe={key:2,class:"detail-item"},Ge={class:"value"},He={key:3,class:"detail-item"},Je=["href"],Ke={key:4,class:"detail-item"},Pe={class:"value"},Ye={__name:"LeaderboardView",setup(Qe){const w=ae();oe();const k=g("official"),_=g("333"),$=g("single"),f=g(!1),h=g(""),N=g(!1),c=g(null),D=g([]),K=async()=>{f.value=!0,h.value="";try{await w.fetchRecords(),T.success("数据刷新成功")}catch(t){console.error("刷新排行榜失败:",t),h.value=t.message||"获取数据失败，请稍后再试"}finally{f.value=!1}};ne(async()=>{f.value=!0,h.value="";try{await w.fetchRecords(),await W()}catch(t){console.error("获取排行榜数据失败:",t),h.value=t.message||"获取数据失败，请稍后再试"}finally{f.value=!1}});const P=H(()=>{if(k.value==="all")return[C.all];if(k.value==="meme"){const t=C.meme.options||[],e=D.value.map(a=>({label:a.eventName,value:a.eventCode})),u=[...t];return e.forEach(a=>{u.some(r=>r.value===a.value)||u.push(a)}),[{label:C.meme.label,options:u}]}return k.value?[C[k.value]]:[]});ie(k,async t=>{_.value=t?`${t}_all`:"",t==="meme"&&await W()});const W=async()=>{try{const t=await re();D.value=t.filter(e=>e.isActive!==!1)}catch(t){console.error("加载整活项目失败:",t),D.value=[]}},Y=H(()=>{if(!_.value||_.value.endsWith("_all"))return[];const t=w.getRecordsByEvent(_.value),e=new Map;return t.forEach(a=>{const r=a.userId;if(!r)return;const p=$.value==="single"?a.singleSeconds:a.averageSeconds;if(p==null)return;const V=a.nickname||w.getNicknameForUser(r)||"未知用户";if(!e.has(r))e.set(r,{userId:r,nickname:V,time:p,recordId:a._id,timestamp:a.timestamp});else{const y=e.get(r);p<y.time&&e.set(r,{userId:r,nickname:V,time:p,recordId:a._id,timestamp:a.timestamp})}}),Array.from(e.values()).sort((a,r)=>a.time-r.time).map((a,r)=>({...a,rank:r+1}))}),L=t=>w.formatTime(t),j=(t,e=!1)=>{if(!t)return"-";let u=t;typeof t=="object"&&t.$date&&(u=t.$date);const a=new Date(u);if(isNaN(a))return"-";const r=a.getFullYear(),p=String(a.getMonth()+1).padStart(2,"0"),V=String(a.getDate()).padStart(2,"0");let y=`${r}.${p}.${V}`;if(e){const F=String(a.getHours()).padStart(2,"0"),E=String(a.getMinutes()).padStart(2,"0");y+=` ${F}:${E}`}return y},O=t=>{var e,u;return t.cube||((e=t.single)==null?void 0:e.cube)||((u=t.average)==null?void 0:u.cube)||""},q=t=>{var e,u;return t.method||((e=t.single)==null?void 0:e.method)||((u=t.average)==null?void 0:u.method)||""},B=t=>t!=null&&t!=="null"&&t!=="",Q=async t=>{try{const e=w.records.find(u=>u._id===t);e?(c.value=e,N.value=!0):T.error("记录不存在")}catch(e){console.error("获取记录详情失败:",e),T.error("获取记录详情失败")}};return(t,e)=>{const u=v("el-button"),a=v("el-alert"),r=v("el-option"),p=v("el-select"),V=v("el-option-group"),y=v("el-radio-button"),F=v("el-radio-group"),E=v("el-icon"),R=v("el-table-column"),X=v("router-link"),Z=v("el-table"),G=v("el-empty"),ee=v("el-dialog"),te=de("loading");return o(),i("div",_e,[n(J,{name:"fade",duration:600,appear:""},{default:d(()=>[s("div",pe,[s("div",fe,[e[5]||(e[5]=s("h1",{class:"page-title"},"排行榜",-1)),n(u,{circle:"",plain:"",size:"small",type:"info",onClick:K,loading:f.value,class:"refresh-icon-button"},{default:d(()=>[f.value?(o(),i("i",be)):(o(),i("img",ge))]),_:1},8,["loading"])])])]),_:1}),h.value?(o(),i("div",ke,[n(a,{title:"获取数据失败",type:"error",description:h.value,"show-icon":"",closable:"",onClose:e[0]||(e[0]=l=>h.value="")},null,8,["description"])])):b("",!0),n(J,{name:"slide-up",duration:600,delay:200,appear:""},{default:d(()=>[ce((o(),i("div",he,[s("div",ye,[e[8]||(e[8]=s("h2",{class:"section-title"},"项目排行榜",-1)),s("div",we,[s("div",Ve,[n(p,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=l=>k.value=l),placeholder:"选择项目类型",class:"category-select glass-select"},{default:d(()=>[(o(!0),i(U,null,z(I(ue),l=>(o(),S(r,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),n(p,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=l=>_.value=l),placeholder:"选择具体项目",class:"event-select glass-select",loading:f.value},{default:d(()=>[(o(!0),i(U,null,z(P.value,l=>(o(),S(V,{key:l.label,label:l.label},{default:d(()=>[(o(!0),i(U,null,z(l.options,x=>(o(),S(r,{key:x.value,label:x.label,value:x.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","loading"]),n(F,{modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=l=>$.value=l),class:"rank-type-select"},{default:d(()=>[n(y,{label:"single"},{default:d(()=>e[6]||(e[6]=[M("单次")])),_:1}),n(y,{label:"average"},{default:d(()=>e[7]||(e[7]=[M("平均")])),_:1})]),_:1},8,["modelValue"])])])]),_.value&&!_.value.endsWith("_all")?(o(),i("div",Se,[n(Z,{data:Y.value,style:{width:"100%"},stripe:!0,class:"leaderboard-table glass-table","empty-text":"暂无排行榜数据"},{default:d(()=>[n(R,{prop:"rank",label:"排名",width:"80",align:"center"},{default:d(l=>[s("div",Ee,[l.row.rank<=3?(o(),i("span",Ie,[l.row.rank===1?(o(),S(E,{key:0,class:"gold-medal"},{default:d(()=>[n(I(A),{icon:"mdi:trophy"})]),_:1})):l.row.rank===2?(o(),S(E,{key:1,class:"silver-medal"},{default:d(()=>[n(I(A),{icon:"mdi:trophy"})]),_:1})):l.row.rank===3?(o(),S(E,{key:2,class:"bronze-medal"},{default:d(()=>[n(I(A),{icon:"mdi:trophy"})]),_:1})):b("",!0)])):(o(),i("span",$e,m(l.row.rank),1))])]),_:1}),n(R,{label:"选手","min-width":"120"},{default:d(l=>[s("div",Re,[n(X,{to:`/user/${l.row.userId}`,class:"player-name"},{default:d(()=>[M(m(l.row.nickname),1)]),_:2},1032,["to"])])]),_:1}),n(R,{label:$.value==="single"?"单次成绩":"平均成绩","min-width":"120",align:"center"},{default:d(l=>[s("div",xe,[s("span",{class:ve(["time-value",{clickable:l.row.recordId}]),onClick:x=>Q(l.row.recordId)},m(L(l.row.time)),11,Ce)])]),_:1},8,["label"]),n(R,{label:"提交时间","min-width":"120","class-name":"hide-on-mobile"},{default:d(l=>[M(m(j(l.row.timestamp)),1)]),_:1})]),_:1},8,["data"])])):_.value&&_.value.endsWith("_all")?(o(),i("div",Me,[n(G,{description:"请选择具体项目查看排行榜"})])):(o(),i("div",Ne,[n(G,{description:"请选择项目查看排行榜"})]))])),[[te,f.value]])]),_:1}),n(ee,{modelValue:N.value,"onUpdate:modelValue":e[4]||(e[4]=l=>N.value=l),title:"记录详情",width:"500px",class:"glass-dialog"},{default:d(()=>[c.value?(o(),i("div",De,[s("div",Le,[e[9]||(e[9]=s("span",{class:"label"},"项目:",-1)),s("span",Be,m(I(me)(c.value.event)),1)]),s("div",Fe,[e[10]||(e[10]=s("span",{class:"label"},"单次成绩:",-1)),s("span",Te,m(c.value.singleSeconds?L(c.value.singleSeconds):"-"),1)]),s("div",Ue,[e[11]||(e[11]=s("span",{class:"label"},"平均成绩:",-1)),s("span",ze,m(c.value.averageSeconds?L(c.value.averageSeconds):"-"),1)]),B(O(c.value))?(o(),i("div",Ae,[e[12]||(e[12]=s("span",{class:"label"},"使用魔方:",-1)),s("span",We,m(O(c.value)),1)])):b("",!0),B(q(c.value))?(o(),i("div",je,[e[13]||(e[13]=s("span",{class:"label"},"使用方法:",-1)),s("span",Oe,m(q(c.value)),1)])):b("",!0),B(c.value.remark)?(o(),i("div",qe,[e[14]||(e[14]=s("span",{class:"label"},"备注:",-1)),s("span",Ge,m(c.value.remark),1)])):b("",!0),c.value.videoLink?(o(),i("div",He,[e[15]||(e[15]=s("span",{class:"label"},"视频链接:",-1)),s("a",{href:c.value.videoLink,target:"_blank",class:"video-link"},m(c.value.videoLink),9,Je)])):b("",!0),c.value.timestamp?(o(),i("div",Ke,[e[16]||(e[16]=s("span",{class:"label"},"提交时间:",-1)),s("span",Pe,m(j(c.value.timestamp,!0)),1)])):b("",!0)])):b("",!0)]),_:1},8,["modelValue"])])}}},tt=se(Ye,[["__scopeId","data-v-137e0511"]]);export{tt as default};
