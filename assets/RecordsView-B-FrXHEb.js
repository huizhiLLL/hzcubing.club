import{_ as ce}from"./refresh-DSDc0Cm4.js";import{_ as ae,b as ne,u as oe,D as ve,r as R,c as A,o as re,E as G,j as h,k as ie,l as t,m as i,y as ee,z as k,p as n,n as v,x as f,t as u,s as E,d as se,q as e,v as y,e as X,w as le,i as me,F as U,A as L,G as _e,H as q}from"./index-Bsn6c0zj.js";/* empty css                                                                     */import{E as Z}from"./ElementTransition-DMMnBOwW.js";const fe={class:"table-container"},ge={key:1},pe={class:"record-cell"},ke={key:0,class:"record-value"},ye={key:0,class:"rank"},we={key:1},be={key:2,class:"holder-nickname"},he={key:1},$e={class:"record-cell"},Se={key:0,class:"record-value"},Re={key:0,class:"rank"},Ie={key:1},He={key:2,class:"holder-nickname"},Te={key:1},Ne={key:1},Ve={key:0,class:"record-details glass-form"},Ue={class:"detail-item"},Be={class:"value"},De={class:"detail-item"},Ee={class:"value"},xe={key:0,class:"detail-item"},ze={class:"value"},Ae={key:1},Ce={key:1,class:"detail-item"},Fe={class:"value"},Me={key:2,class:"detail-item"},Le={class:"value"},Ge={class:"detail-item"},Oe={class:"value"},je={key:3,class:"detail-item"},Pe={class:"value"},Ye={key:1},qe={key:4,class:"detail-item"},We={class:"value"},Je={key:5,class:"detail-item"},Ke=["href"],Qe={key:6,class:"detail-item"},Xe={class:"value"},Ze={key:7,class:"actions"},et={class:"dialog-footer"},tt={__name:"RecordsTable",props:{records:{type:Array,default:()=>[]},showActions:{type:Boolean,default:!0},autoRefresh:{type:Boolean,default:!0},isDebug:{type:Boolean,default:!1}},emits:["refresh","delete"],setup(te,{emit:W}){const b=te,C=W,H=ne(),T=oe();ve();const S=R(!1),N=R(!1),B=R(!1),$=R(!1),r=R(null),O=c=>{var s,_;return c.cube||((s=c.single)==null?void 0:s.cube)||((_=c.average)==null?void 0:_.cube)||""},j=c=>{var s,_;return c.method||((s=c.single)==null?void 0:s.method)||((_=c.average)==null?void 0:_.method)||""},F=c=>c!=null&&c!=="null"&&c!=="",x=c=>H.formatTime(c),J=(c,s=!1)=>{if(!c)return"-";const _=new Date(c);if(isNaN(_))return"-";const d=_.getFullYear(),g=String(_.getMonth()+1).padStart(2,"0"),w=String(_.getDate()).padStart(2,"0");let p=`${d}.${g}.${w}`;if(s){const I=String(_.getHours()).padStart(2,"0"),o=String(_.getMinutes()).padStart(2,"0");p+=` ${I}:${o}`}return p},z=A(()=>b.records),M=async()=>{if(b.autoRefresh){S.value=!0;try{await H.fetchRecords(),C("refresh")}catch{G.error("刷新数据失败")}finally{S.value=!1}}else C("refresh")},K=c=>!T.user||!c?!1:c.userId===T.user._id,m=()=>{$.value=!0},a=async()=>{if(!r.value||!r.value._id){G.error("无法删除，记录ID不存在"),$.value=!1;return}N.value=!0;try{await H.deleteRecord(r.value._id),G.success("记录已删除"),$.value=!1,B.value=!1,C("delete",r.value._id),M()}catch(c){G.error("删除失败: "+c.message)}finally{N.value=!1}};return re(()=>{b.autoRefresh&&M()}),(c,s)=>{const _=h("el-table-column"),d=h("router-link"),g=h("el-table"),w=h("el-button"),p=h("el-dialog"),I=ie("loading");return t(),i("div",fe,[ee((t(),k(g,{data:z.value,style:{width:"100%"},stripe:!0,class:"records-table glass-table"},{default:n(()=>[v(_,{label:"项目","min-width":"100"},{default:n(o=>[f(u(E(se)(o.row.event)),1)]),_:1}),v(_,{label:"昵称","min-width":"120","class-name":"nickname-column"},{default:n(o=>[o.row.singleHolderUserId?(t(),k(d,{key:0,to:`/user/${o.row.singleHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(u(o.row.singleHolderNickname||"-"),1)]),_:2},1032,["to"])):(t(),i("span",ge,u(o.row.singleHolderNickname||"-"),1))]),_:1}),v(_,{label:"单次","min-width":"100"},{default:n(o=>[e("div",pe,[o.row.singleSeconds!==void 0?(t(),i("span",ke,[f(u(x(o.row.singleSeconds))+" ",1),o.row.singleRank?(t(),i("span",ye,"(#"+u(o.row.singleRank)+")",1)):y("",!0)])):(t(),i("span",we,"-")),o.row.singleHolderNickname?(t(),i("span",be,[o.row.singleHolderUserId?(t(),k(d,{key:0,to:`/user/${o.row.singleHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(u(o.row.singleHolderNickname),1)]),_:2},1032,["to"])):(t(),i("span",he,u(o.row.singleHolderNickname),1))])):y("",!0)])]),_:1}),v(_,{label:"平均","min-width":"100"},{default:n(o=>[e("div",$e,[o.row.averageSeconds!==void 0?(t(),i("span",Se,[f(u(x(o.row.averageSeconds))+" ",1),o.row.averageRank?(t(),i("span",Re,"(#"+u(o.row.averageRank)+")",1)):y("",!0)])):(t(),i("span",Ie,"-")),o.row.averageHolderNickname?(t(),i("span",He,[o.row.averageHolderUserId?(t(),k(d,{key:0,to:`/user/${o.row.averageHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(u(o.row.averageHolderNickname),1)]),_:2},1032,["to"])):(t(),i("span",Te,u(o.row.averageHolderNickname),1))])):y("",!0)])]),_:1}),v(_,{label:"昵称","min-width":"120","class-name":"nickname-column"},{default:n(o=>[o.row.averageHolderUserId?(t(),k(d,{key:0,to:`/user/${o.row.averageHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(u(o.row.averageHolderNickname||"-"),1)]),_:2},1032,["to"])):(t(),i("span",Ne,u(o.row.averageHolderNickname||"-"),1))]),_:1})]),_:1},8,["data"])),[[I,S.value]]),v(p,{modelValue:B.value,"onUpdate:modelValue":s[0]||(s[0]=o=>B.value=o),title:"成绩详情",width:"500px",class:"glass-dialog"},{default:n(()=>[r.value?(t(),i("div",Ve,[e("div",Ue,[s[3]||(s[3]=e("span",{class:"label"},"项目:",-1)),e("span",Be,u(E(se)(r.value.event)),1)]),e("div",De,[s[4]||(s[4]=e("span",{class:"label"},"单次成绩:",-1)),e("span",Ee,u(r.value.singleSeconds?x(r.value.singleSeconds):"-"),1)]),r.value.singleHolderUserId||r.value.singleHolderNickname?(t(),i("div",xe,[s[5]||(s[5]=e("span",{class:"label"},"单次保持者:",-1)),e("span",ze,[r.value.singleHolderUserId?(t(),k(d,{key:0,to:`/user/${r.value.singleHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(u(r.value.singleHolderNickname||"-"),1)]),_:1},8,["to"])):(t(),i("span",Ae,u(r.value.singleHolderNickname||"-"),1))])])):y("",!0),F(O(r.value))?(t(),i("div",Ce,[s[6]||(s[6]=e("span",{class:"label"},"使用魔方:",-1)),e("span",Fe,u(O(r.value)),1)])):y("",!0),F(j(r.value))?(t(),i("div",Me,[s[7]||(s[7]=e("span",{class:"label"},"使用方法:",-1)),e("span",Le,u(j(r.value)),1)])):y("",!0),e("div",Ge,[s[8]||(s[8]=e("span",{class:"label"},"平均成绩:",-1)),e("span",Oe,u(r.value.averageSeconds!==void 0?x(r.value.averageSeconds):"-"),1)]),r.value.averageHolderUserId||r.value.averageHolderNickname?(t(),i("div",je,[s[9]||(s[9]=e("span",{class:"label"},"平均保持者:",-1)),e("span",Pe,[r.value.averageHolderUserId?(t(),k(d,{key:0,to:`/user/${r.value.averageHolderUserId}`,class:"player-name-link"},{default:n(()=>[f(u(r.value.averageHolderNickname||"-"),1)]),_:1},8,["to"])):(t(),i("span",Ye,u(r.value.averageHolderNickname||"-"),1))])])):y("",!0),F(r.value.remark)?(t(),i("div",qe,[s[10]||(s[10]=e("span",{class:"label"},"备注:",-1)),e("span",We,u(r.value.remark),1)])):y("",!0),r.value.videoLink?(t(),i("div",Je,[s[11]||(s[11]=e("span",{class:"label"},"视频链接:",-1)),e("a",{href:r.value.videoLink,target:"_blank",class:"video-link"},u(r.value.videoLink),9,Ke)])):y("",!0),r.value.timestamp?(t(),i("div",Qe,[s[12]||(s[12]=e("span",{class:"label"},"提交时间:",-1)),e("span",Xe,u(J(r.value.timestamp,!0)),1)])):y("",!0),K(r.value)?(t(),i("div",Ze,[v(w,{type:"danger",size:"small",onClick:m},{default:n(()=>s[13]||(s[13]=[f("删除")])),_:1})])):y("",!0)])):y("",!0)]),_:1},8,["modelValue"]),v(p,{modelValue:$.value,"onUpdate:modelValue":s[2]||(s[2]=o=>$.value=o),title:"确认删除",width:"300px",class:"glass-dialog"},{footer:n(()=>[e("span",et,[v(w,{onClick:s[1]||(s[1]=o=>$.value=!1)},{default:n(()=>s[14]||(s[14]=[f("取消")])),_:1}),v(w,{type:"danger",onClick:a,loading:N.value},{default:n(()=>s[15]||(s[15]=[f("确定")])),_:1},8,["loading"])])]),default:n(()=>[s[16]||(s[16]=e("p",null,"确定要删除这条成绩记录吗？此操作不可恢复。",-1))]),_:1},8,["modelValue"])])}}},st=ae(tt,[["__scopeId","data-v-9c2186dd"]]),lt={class:"records-container"},at={class:"page-header glass-header"},nt={class:"title-with-refresh"},ot={key:0,src:ce,alt:"刷新",class:"refresh-icon"},rt={key:1,class:"el-icon-loading"},it={class:"header-actions"},dt={key:0,class:"error-alert"},ut={class:"card glass-card"},ct={class:"filter-header"},vt={class:"filter-controls"},mt={class:"table-responsive"},_t={class:"card glass-card"},ft={class:"filter-header"},gt={class:"filter-controls"},pt={key:0,class:"table-responsive"},kt={class:"record-details"},yt={class:"detail-item"},wt={class:"detail-value"},bt={class:"detail-item"},ht={class:"detail-value"},$t={class:"detail-item"},St={class:"detail-value"},Rt={class:"detail-item"},It={class:"detail-value"},Ht={class:"detail-item"},Tt={class:"detail-value"},Nt={class:"record-cell"},Vt={class:"record-main"},Ut={class:"record-sub"},Bt={class:"record-cell"},Dt={class:"record-main"},Et={class:"record-sub"},xt={class:"pagination"},zt={__name:"RecordsView",setup(te){const W=oe(),b=ne(),{user:C}=W,H=R("official"),T=R("official_all"),S=R("333"),N=R(1),B=R(10),$=R(!1),r=R(""),O=async()=>{$.value=!0,r.value="";try{await b.fetchRecords(),G.success("数据刷新成功")}catch(m){console.error("刷新记录失败:",m),r.value=m.message||"获取数据失败，请稍后再试"}finally{$.value=!1}};re(async()=>{$.value=!0,r.value="";try{await b.fetchRecords();const m=b.getRecordsByEvent(S.value);await b.ensureNicknamesForRecords(m)}catch(m){console.error("获取记录失败:",m),r.value=m.message||"获取数据失败，请稍后再试"}finally{$.value=!1}});const j=A(()=>H.value==="all"?[X.all]:H.value?[X[H.value]]:[]);le(H,m=>{T.value=m?`${m}_all`:""});const F=A(()=>{var a;const m=b.getBestRecords();if(T.value==="all_all")return Object.values(m);if(T.value.endsWith("_all")){const c=T.value.split("_")[0],_=(((a=X[c])==null?void 0:a.options)||[]).slice(1).map(d=>d.value);return Object.values(m).filter(d=>_.includes(d.event))}return[m[T.value]].filter(Boolean)}),x=A(()=>{if(!S.value)return[];const m=b.getRecordsByEvent(S.value),a=[];let c=1/0,s=1/0;return[...m].sort((d,g)=>{var I,o,D,P;const w=d.timestamp?new Date(d.timestamp).getTime():0,p=g.timestamp?new Date(g.timestamp).getTime():0;if(w===p){const Q=(I=d.single)!=null&&I.time?b.convertToSeconds(d.single.time):1/0,Y=(o=g.single)!=null&&o.time?b.convertToSeconds(g.single.time):1/0,l=(D=d.average)!=null&&D.time?b.convertToSeconds(d.average.time):1/0,V=(P=g.average)!=null&&P.time?b.convertToSeconds(g.average.time):1/0,de=Math.min(Q,l),ue=Math.min(Y,V);return de-ue}return w-p}).forEach(d=>{let g=!1;const w=typeof d.singleSeconds=="number"?d.singleSeconds:null,p=typeof d.averageSeconds=="number"?d.averageSeconds:null;w!==null&&w<c&&(c=w,g=!0),p!==null&&p<s&&(s=p,g=!0),g&&a.push({...d,isSingleRecord:w!==null&&w===c,isAverageRecord:p!==null&&p===s,nickname:d.nickname||b.getNicknameForUser(d.userId)||""})}),a.reverse(),a.slice((N.value-1)*B.value,N.value*B.value)}),J=A(()=>{if(!S.value)return 0;const m=b.getRecordsByEvent(S.value);let a=1/0,c=1/0,s=0;return[...m].sort((d,g)=>{const w=d.timestamp?new Date(d.timestamp).getTime():0,p=g.timestamp?new Date(g.timestamp).getTime():0;return w-p}).forEach(d=>{let g=!1;const w=typeof d.singleSeconds=="number"?d.singleSeconds:null,p=typeof d.averageSeconds=="number"?d.averageSeconds:null;w!==null&&w<a&&(a=w,g=!0),p!==null&&p<c&&(c=p,g=!0),g&&s++}),s});le(S,()=>{N.value=1;const m=b.getRecordsByEvent(S.value);b.ensureNicknamesForRecords(m)});const z=m=>b.formatTime(m),M=m=>{if(!m)return"-";const a=new Date(m),c=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),_=String(a.getDate()).padStart(2,"0");return`${c}.${s}.${_}`},K=A(()=>me());return(m,a)=>{const c=h("el-button"),s=h("router-link"),_=h("el-alert"),d=h("el-option"),g=h("el-select"),w=h("el-option-group"),p=h("el-tag"),I=h("el-icon"),o=h("el-tooltip"),D=h("el-table-column"),P=h("el-table"),Q=h("el-pagination"),Y=ie("loading");return t(),i("div",lt,[v(Z,{name:"fade",duration:600,appear:""},{default:n(()=>[e("div",at,[e("div",nt,[a[6]||(a[6]=e("h1",{class:"page-title"},"记录统计",-1)),v(c,{circle:"",plain:"",size:"small",type:"info",onClick:O,loading:$.value,class:"refresh-icon-button"},{default:n(()=>[$.value?(t(),i("i",rt)):(t(),i("img",ot))]),_:1},8,["loading"])]),e("div",it,[E(C)?(t(),k(s,{key:0,to:"/submit-record"},{default:n(()=>[v(c,{type:"primary"},{default:n(()=>a[7]||(a[7]=[f("上传成绩")])),_:1})]),_:1})):y("",!0)])])]),_:1}),r.value?(t(),i("div",dt,[v(_,{title:"获取数据失败",type:"error",description:r.value,"show-icon":"",closable:"",onClose:a[0]||(a[0]=l=>r.value="")},null,8,["description"])])):y("",!0),v(Z,{name:"slide-up",duration:600,delay:200,appear:""},{default:n(()=>[ee((t(),i("div",ut,[e("div",ct,[a[8]||(a[8]=e("h2",{class:"section-title"},"最佳记录",-1)),e("div",vt,[v(g,{modelValue:H.value,"onUpdate:modelValue":a[1]||(a[1]=l=>H.value=l),placeholder:"选择项目类型",class:"category-select glass-select"},{default:n(()=>[(t(!0),i(U,null,L(E(_e),l=>(t(),k(d,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),v(g,{modelValue:T.value,"onUpdate:modelValue":a[2]||(a[2]=l=>T.value=l),placeholder:"选择具体项目",class:"event-select glass-select",loading:$.value},{default:n(()=>[(t(!0),i(U,null,L(j.value,l=>(t(),k(w,{key:l.label,label:l.label},{default:n(()=>[(t(!0),i(U,null,L(l.options,V=>(t(),k(d,{key:V.value,label:V.label,value:V.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","loading"])])]),e("div",mt,[v(st,{records:F.value},null,8,["records"])])])),[[Y,$.value]])]),_:1}),v(Z,{name:"slide-up",duration:600,delay:400,appear:""},{default:n(()=>[ee((t(),i("div",_t,[e("div",ft,[a[9]||(a[9]=e("h2",{class:"section-title"},"历史记录",-1)),e("div",gt,[v(g,{modelValue:S.value,"onUpdate:modelValue":a[3]||(a[3]=l=>S.value=l),placeholder:"选择项目",class:"event-select glass-select"},{default:n(()=>[(t(!0),i(U,null,L(K.value,l=>(t(),k(w,{key:l.label,label:l.label},{default:n(()=>[(t(!0),i(U,null,L(l.options,V=>(t(),k(d,{key:V.value,label:V.label,value:V.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])]),S.value?(t(),i("div",pt,[v(P,{data:x.value,style:{width:"100%"},stripe:!0,class:"custom-table glass-table"},{default:n(()=>[v(D,{type:"expand"},{default:n(l=>[e("div",kt,[e("div",yt,[a[11]||(a[11]=e("span",{class:"detail-label"},"单次成绩：",-1)),e("span",wt,[f(u(z(l.row.singleSeconds))+" ",1),l.row.isSingleRecord?(t(),k(p,{key:0,size:"small",type:"danger",effect:"dark"},{default:n(()=>a[10]||(a[10]=[f("GR")])),_:1})):y("",!0)])]),e("div",bt,[a[12]||(a[12]=e("span",{class:"detail-label"},"单次保持者：",-1)),e("span",ht,[l.row.userId?(t(),k(s,{key:0,to:`/user/${l.row.userId}`,class:"player-link"},{default:n(()=>[f(u(l.row.nickname||"未知"),1)]),_:2},1032,["to"])):(t(),i(U,{key:1},[e("span",null,u(l.row.nickname||"-"),1),l.row.nickname?(t(),k(o,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:n(()=>[v(I,{class:"info-icon"},{default:n(()=>[v(E(q))]),_:1})]),_:1})):y("",!0)],64))])]),e("div",$t,[a[14]||(a[14]=e("span",{class:"detail-label"},"平均成绩：",-1)),e("span",St,[f(u(z(l.row.averageSeconds))+" ",1),l.row.isAverageRecord?(t(),k(p,{key:0,size:"small",type:"danger",effect:"dark"},{default:n(()=>a[13]||(a[13]=[f("GR")])),_:1})):y("",!0)])]),e("div",Rt,[a[15]||(a[15]=e("span",{class:"detail-label"},"平均保持者：",-1)),e("span",It,[l.row.userId?(t(),k(s,{key:0,to:`/user/${l.row.userId}`,class:"player-link"},{default:n(()=>[f(u(l.row.nickname||"未知"),1)]),_:2},1032,["to"])):(t(),i(U,{key:1},[e("span",null,u(l.row.nickname||"-"),1),l.row.nickname?(t(),k(o,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:n(()=>[v(I,{class:"info-icon"},{default:n(()=>[v(E(q))]),_:1})]),_:1})):y("",!0)],64))])]),e("div",Ht,[a[16]||(a[16]=e("span",{class:"detail-label"},"记录时间：",-1)),e("span",Tt,u(M(l.row.timestamp)),1)])])]),_:1}),v(D,{prop:"index",label:"序号","min-width":"60",type:"index",index:1}),v(D,{label:"单次","min-width":"160"},{default:n(l=>[e("div",Nt,[e("div",Vt,[f(u(z(l.row.singleSeconds))+" ",1),l.row.isSingleRecord?(t(),k(p,{key:0,size:"small",type:"danger",effect:"dark"},{default:n(()=>a[17]||(a[17]=[f("GR")])),_:1})):y("",!0)]),e("div",Ut,[l.row.userId?(t(),k(s,{key:0,to:`/user/${l.row.userId}`,class:"player-link"},{default:n(()=>[f(u(l.row.nickname||"未知"),1)]),_:2},1032,["to"])):(t(),i(U,{key:1},[e("span",null,u(l.row.nickname||"-"),1),l.row.nickname?(t(),k(o,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:n(()=>[v(I,{class:"info-icon"},{default:n(()=>[v(E(q))]),_:1})]),_:1})):y("",!0)],64))])])]),_:1}),v(D,{label:"平均","min-width":"160"},{default:n(l=>[e("div",Bt,[e("div",Dt,[f(u(z(l.row.averageSeconds))+" ",1),l.row.isAverageRecord?(t(),k(p,{key:0,size:"small",type:"danger",effect:"dark"},{default:n(()=>a[18]||(a[18]=[f("GR")])),_:1})):y("",!0)]),e("div",Et,[l.row.userId?(t(),k(s,{key:0,to:`/user/${l.row.userId}`,class:"player-link"},{default:n(()=>[f(u(l.row.nickname||"未知"),1)]),_:2},1032,["to"])):(t(),i(U,{key:1},[e("span",null,u(l.row.nickname||"-"),1),l.row.nickname?(t(),k(o,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:n(()=>[v(I,{class:"info-icon"},{default:n(()=>[v(E(q))]),_:1})]),_:1})):y("",!0)],64))])])]),_:1}),v(D,{prop:"timestamp",label:"时间","min-width":"120","class-name":"hide-on-mobile"},{default:n(l=>[f(u(M(l.row.timestamp)),1)]),_:1})]),_:1},8,["data"]),e("div",xt,[v(Q,{"current-page":N.value,"onUpdate:currentPage":a[4]||(a[4]=l=>N.value=l),"page-size":B.value,"onUpdate:pageSize":a[5]||(a[5]=l=>B.value=l),total:J.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",class:"responsive-pagination"},null,8,["current-page","page-size","total"])])])):y("",!0)])),[[Y,$.value]])]),_:1})])}}},Lt=ae(zt,[["__scopeId","data-v-0ce70987"]]);export{Lt as default};
