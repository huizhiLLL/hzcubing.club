import{_ as ie,r,o as de,a as I,u as G,w as H,j as i,l as u,m as v,q as t,n as l,p as a,t as c,s as V,Q as ce,Z as me,x as m,z as $,F as A,A as L,J as pe,T as ve,v as K,N as _e,E as y,$ as fe,C as ye,P as be,a0 as ge}from"./index-CK2GeIUh.js";const ke={class:"online-competition"},we={class:"competition-container"},Ne={class:"competition-content"},Ve={class:"event-info"},he={class:"event-title"},Ce={class:"results-table"},Se={class:"card-header"},Ue={class:"header-actions"},Ee={class:"table-container"},Re={key:0,class:"loading-container"},ze={key:1,class:"error-container"},De={class:"rank-number"},Fe=["title"],Me={class:"average-time"},Ie={class:"single-time"},$e={class:"scores-container"},qe={key:2,class:"no-permission"},xe={class:"scores-input"},Be={class:"score-label"},Oe={class:"dialog-footer"},Te={class:"scores-input"},Ae={class:"score-label"},Le={class:"dialog-footer"},Ze={__name:"OnlineCompetition",setup(je){const d=r("333"),R=r([]),q=r(!1),h=r(""),x=r(!1),X=r(1),Z=()=>{x.value=window.innerWidth<=768},z=r(!1),C=r(!1),S=r(!1),g=r(!1),B=r(),O=r(),_=r({playerName:"",scores:["","","","",""]}),p=r({playerId:"",playerName:"",scores:["","","","",""]}),j={playerName:[{required:!0,message:"请输入选手姓名",trigger:"blur"}],scores:[{required:!0,message:"请输入五次成绩",trigger:"blur"}]},Y=s=>{d.value=s,D()},T=s=>({333:"三阶",222:"二阶","333oh":"三单",444:"四阶"})[s]||"未知项目",D=async()=>{q.value=!0,h.value="";try{const s=await I.getOnlineMatchResults({event:d.value,action:"getResults"});s.success?R.value=s.results||[]:(console.error("获取比赛结果失败:",s.message),h.value=s.message||"获取数据失败",R.value=[])}catch(s){console.error("获取比赛结果失败:",s),h.value="网络错误，请稍后重试",R.value=[]}finally{q.value=!1}},U=()=>{D()},J=()=>{const s=F(),e=["3169164181@qq.com","3679063384@qq.com"];z.value=e.includes(s)},F=()=>{var e;return((e=G().user)==null?void 0:e.email)||""},ee=()=>{_.value={playerName:"",scores:["","","","",""]},C.value=!0},le=async()=>{if(B.value)try{await B.value.validate(),g.value=!0;const s=F(),e=await I.submitOnlineMatchResult({event:d.value,action:"addScore",playerName:_.value.playerName,scores:_.value.scores,email:s});e.success?(y.success("成绩录入成功"),C.value=!1,U()):y.error(e.message||"录入失败")}catch(s){console.error("录入成绩失败:",s),y.error("录入失败，请重试")}finally{g.value=!1}},ae=s=>{p.value={playerId:s.playerId||s._id,playerName:s.playerName,scores:s.rawScores||s.scores.map(e=>e.value)},S.value=!0},se=async()=>{if(O.value)try{await O.value.validate(),g.value=!0;const s=F(),e=await I.submitOnlineMatchResult({event:d.value,action:"updateScore",playerId:p.value.playerId,playerName:p.value.playerName,scores:p.value.scores,email:s});e.success?(y.success("成绩更新成功"),S.value=!1,U()):y.error(e.message||"更新失败")}catch(s){console.error("更新成绩失败:",s),y.error("更新失败，请重试")}finally{g.value=!1}},te=async s=>{try{await _e.confirm(`确定要删除选手 ${s.playerName} 的成绩吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=F(),b=await I.submitOnlineMatchResult({event:d.value,action:"deleteScore",playerId:s.playerId||s._id,email:e});b.success?(y.success("删除成功"),U()):y.error(b.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除成绩失败:",e),y.error("删除失败，请重试"))}};de(()=>{D(),J(),Z(),window.addEventListener("resize",Z)}),H(d,()=>{D()});const oe=G();return H(()=>oe.user,()=>{J()},{immediate:!0}),(s,e)=>{const b=i("el-tab-pane"),ne=i("el-tabs"),k=i("el-icon"),f=i("el-button"),w=i("el-table-column"),re=i("el-table"),ue=i("el-card"),M=i("el-input"),N=i("el-form-item"),P=i("el-tag"),Q=i("el-form"),W=i("el-dialog");return u(),v("div",ke,[e[22]||(e[22]=t("div",{class:"page-header"},[t("h1",{class:"page-title"},"2025会枝杯夏季线上赛")],-1)),t("div",we,[l(ne,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=o=>d.value=o),class:"event-tabs",onTabChange:Y},{default:a(()=>[l(b,{label:"三阶",name:"333"},{label:a(()=>e[7]||(e[7]=[t("span",{class:"event-label"},"三阶",-1)])),_:1}),l(b,{label:"二阶",name:"222"},{label:a(()=>e[8]||(e[8]=[t("span",{class:"event-label"},"二阶",-1)])),_:1}),l(b,{label:"三单",name:"333oh"},{label:a(()=>e[9]||(e[9]=[t("span",{class:"event-label"},"三单",-1)])),_:1}),l(b,{label:"四阶",name:"444"},{label:a(()=>e[10]||(e[10]=[t("span",{class:"event-label"},"四阶",-1)])),_:1})]),_:1},8,["modelValue"]),t("div",Ne,[t("div",Ve,[t("h2",he,c(T(d.value)),1)]),t("div",Ce,[l(ue,{class:"table-card"},{header:a(()=>[t("div",Se,[e[13]||(e[13]=t("span",null,"成绩排名",-1)),t("div",Ue,[z.value?(u(),$(f,{key:0,type:"success",size:"small",onClick:ee},{default:a(()=>[l(k,null,{default:a(()=>[l(V(be))]),_:1}),e[11]||(e[11]=m(" 录入成绩 "))]),_:1})):K("",!0),l(f,{type:"primary",size:"small",onClick:U},{default:a(()=>[l(k,null,{default:a(()=>[l(V(ge))]),_:1}),e[12]||(e[12]=m(" 刷新 "))]),_:1})])])]),default:a(()=>[t("div",Ee,[q.value?(u(),v("div",Re,[l(k,{class:"is-loading"},{default:a(()=>[l(V(ce))]),_:1}),e[14]||(e[14]=t("span",null,"加载中...",-1))])):h.value?(u(),v("div",ze,[l(k,null,{default:a(()=>[l(V(me))]),_:1}),t("span",null,c(h.value),1),l(f,{type:"primary",size:"small",onClick:U},{default:a(()=>e[15]||(e[15]=[m("重试")])),_:1})])):(u(),$(re,{key:2,data:R.value,stripe:"",class:"results-table",style:ye({transform:`scale(${X.value})`,transformOrigin:"top left"})},{default:a(()=>[l(w,{prop:"rank",label:"排名",width:"60",align:"center","class-name":"el-table-column--rank"},{default:a(o=>[t("span",De,c(o.row.rank),1)]),_:1}),l(w,{prop:"playerName",label:"玩家名",width:"120","class-name":"el-table-column--player"},{default:a(o=>[t("span",{class:"player-name",title:o.row.playerName},c(o.row.playerName),9,Fe)]),_:1}),l(w,{prop:"average",label:"平均",width:"90",align:"center","class-name":"el-table-column--average"},{default:a(o=>[t("span",Me,c(o.row.average),1)]),_:1}),l(w,{prop:"single",label:"单次",width:"90",align:"center","class-name":"el-table-column--single"},{default:a(o=>[t("span",Ie,c(o.row.single),1)]),_:1}),l(w,{prop:"scores",label:"成绩","min-width":"200","class-name":"el-table-column--scores"},{default:a(o=>[t("div",$e,[(u(!0),v(A,null,L(o.row.scores,(n,E)=>(u(),v("span",{key:E,class:pe(["score-item",{"dropped-score":n.isDropped}])},c(n.isDropped?`(${n.value})`:n.value),3))),128))])]),_:1}),l(w,{label:"操作",width:"150",align:"center","class-name":"el-table-column--actions"},{default:a(o=>[z.value?(u(),$(f,{key:0,type:"primary",size:"small",onClick:n=>ae(o.row)},{default:a(()=>[l(k,null,{default:a(()=>[l(V(ve))]),_:1}),e[16]||(e[16]=m(" 编辑 "))]),_:2},1032,["onClick"])):K("",!0),z.value?(u(),$(f,{key:1,type:"danger",size:"small",onClick:n=>te(o.row)},{default:a(()=>[l(k,null,{default:a(()=>[l(V(fe))]),_:1}),e[17]||(e[17]=m(" 删除 "))]),_:2},1032,["onClick"])):(u(),v("span",qe,"仅管理员可操作"))]),_:1})]),_:1},8,["data","style"]))])]),_:1})])])]),l(W,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=o=>C.value=o),title:"录入成绩",width:x.value?"90%":"600px","close-on-click-modal":!1},{footer:a(()=>[t("span",Oe,[l(f,{onClick:e[2]||(e[2]=o=>C.value=!1)},{default:a(()=>e[18]||(e[18]=[m("取消")])),_:1}),l(f,{type:"primary",onClick:le,loading:g.value},{default:a(()=>e[19]||(e[19]=[m("确定")])),_:1},8,["loading"])])]),default:a(()=>[l(Q,{model:_.value,rules:j,ref_key:"scoreFormRef",ref:B,"label-width":"100px"},{default:a(()=>[l(N,{label:"选手姓名",prop:"playerName"},{default:a(()=>[l(M,{modelValue:_.value.playerName,"onUpdate:modelValue":e[1]||(e[1]=o=>_.value.playerName=o),placeholder:"请输入选手姓名"},null,8,["modelValue"])]),_:1}),l(N,{label:"项目类型"},{default:a(()=>[l(P,{type:"info",size:"large"},{default:a(()=>[m(c(T(d.value)),1)]),_:1})]),_:1}),l(N,{label:"五次成绩",prop:"scores"},{default:a(()=>[t("div",xe,[(u(!0),v(A,null,L(_.value.scores,(o,n)=>(u(),v("div",{key:n,class:"score-input-item"},[t("span",Be,"第"+c(n+1)+"次",1),l(M,{modelValue:_.value.scores[n],"onUpdate:modelValue":E=>_.value.scores[n]=E,placeholder:"成绩或DNF/DNS",class:"score-input"},null,8,["modelValue","onUpdate:modelValue"])]))),128))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"]),l(W,{modelValue:S.value,"onUpdate:modelValue":e[6]||(e[6]=o=>S.value=o),title:"编辑成绩",width:x.value?"90%":"600px","close-on-click-modal":!1},{footer:a(()=>[t("span",Le,[l(f,{onClick:e[5]||(e[5]=o=>S.value=!1)},{default:a(()=>e[20]||(e[20]=[m("取消")])),_:1}),l(f,{type:"primary",onClick:se,loading:g.value},{default:a(()=>e[21]||(e[21]=[m("更新")])),_:1},8,["loading"])])]),default:a(()=>[l(Q,{model:p.value,rules:j,ref_key:"editFormRef",ref:O,"label-width":"100px"},{default:a(()=>[l(N,{label:"选手姓名",prop:"playerName"},{default:a(()=>[l(M,{modelValue:p.value.playerName,"onUpdate:modelValue":e[4]||(e[4]=o=>p.value.playerName=o),placeholder:"请输入选手姓名"},null,8,["modelValue"])]),_:1}),l(N,{label:"项目类型"},{default:a(()=>[l(P,{type:"info",size:"large"},{default:a(()=>[m(c(T(d.value)),1)]),_:1})]),_:1}),l(N,{label:"五次成绩",prop:"scores"},{default:a(()=>[t("div",Te,[(u(!0),v(A,null,L(p.value.scores,(o,n)=>(u(),v("div",{key:n,class:"score-input-item"},[t("span",Ae,"第"+c(n+1)+"次",1),l(M,{modelValue:p.value.scores[n],"onUpdate:modelValue":E=>p.value.scores[n]=E,placeholder:"成绩或DNF/DNS",class:"score-input"},null,8,["modelValue","onUpdate:modelValue"])]))),128))])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","width"])])}}},Pe=ie(Ze,[["__scopeId","data-v-1e6990d0"]]);export{Pe as default};
