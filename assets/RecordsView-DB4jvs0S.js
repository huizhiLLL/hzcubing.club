import{_ as se}from"./refresh-DSDc0Cm4.js";import{_ as ae,u as ne,b as oe,r as z,o as ie,c as $,e as j,w as P,i as re,j as y,k as de,l as s,m as v,n as i,p as a,q as l,E as ce,s as A,z as c,x as f,v as k,y as q,F as R,A as N,D as ue,t as g,G as M}from"./index-Bq31S5oz.js";import{R as ve}from"./RecordsTable-Dy_ydgLE.js";import{E as H}from"./ElementTransition-DUTP6Xtl.js";const me={class:"records-container"},_e={class:"page-header glass-header"},fe={class:"title-with-refresh"},ge={key:0,src:se,alt:"刷新",class:"refresh-icon"},pe={key:1,class:"el-icon-loading"},ye={class:"header-actions"},ke={key:0,class:"error-alert"},be={class:"card glass-card"},we={class:"filter-header"},he={class:"filter-controls"},Re={class:"table-responsive"},Se={class:"card glass-card"},Te={class:"filter-header"},Ie={class:"filter-controls"},Be={key:0,class:"table-responsive"},Ee={class:"record-details"},Ve={class:"detail-item"},ze={class:"detail-value"},xe={class:"detail-item"},Ae={class:"detail-value"},De={class:"detail-item"},$e={class:"detail-value"},Ne={class:"detail-item"},Ue={class:"detail-value"},Fe={class:"detail-item"},Ce={class:"detail-value"},Ge={class:"record-cell"},Me={class:"record-main"},Oe={class:"record-sub"},je={class:"record-cell"},He={class:"record-main"},Le={class:"record-sub"},Pe={class:"pagination"},qe={__name:"RecordsView",setup(We){const W=ne(),m=oe(),{user:Y}=W,x=z("official"),T=z("official_all"),b=z("333"),D=z(1),U=z(10),w=z(!1),I=z(""),J=async()=>{w.value=!0,I.value="";try{await m.fetchRecords(),ce.success("数据刷新成功")}catch(o){console.error("刷新记录失败:",o),I.value=o.message||"获取数据失败，请稍后再试"}finally{w.value=!1}};ie(async()=>{w.value=!0,I.value="";try{await m.fetchRecords();const o=m.getRecordsByEvent(b.value);await m.ensureNicknamesForRecords(o)}catch(o){console.error("获取记录失败:",o),I.value=o.message||"获取数据失败，请稍后再试"}finally{w.value=!1}});const K=$(()=>x.value==="all"?[j.all]:x.value?[j[x.value]]:[]);P(x,o=>{T.value=o?`${o}_all`:""});const Q=$(()=>{var t;const o=m.getBestRecords();if(T.value==="all_all")return Object.values(o);if(T.value.endsWith("_all")){const p=T.value.split("_")[0],B=(((t=j[p])==null?void 0:t.options)||[]).slice(1).map(n=>n.value);return Object.values(o).filter(n=>B.includes(n.event))}return[o[T.value]].filter(Boolean)}),X=$(()=>{if(!b.value)return[];const o=m.getRecordsByEvent(b.value),t=[];let p=1/0,_=1/0;return[...o].sort((n,r)=>{var E,V,S,C;const u=n.timestamp?new Date(n.timestamp).getTime():0,d=r.timestamp?new Date(r.timestamp).getTime():0;if(u===d){const O=(E=n.single)!=null&&E.time?m.convertToSeconds(n.single.time):1/0,G=(V=r.single)!=null&&V.time?m.convertToSeconds(r.single.time):1/0,e=(S=n.average)!=null&&S.time?m.convertToSeconds(n.average.time):1/0,h=(C=r.average)!=null&&C.time?m.convertToSeconds(r.average.time):1/0,te=Math.min(O,e),le=Math.min(G,h);return te-le}return u-d}).forEach(n=>{let r=!1;const u=typeof n.singleSeconds=="number"?n.singleSeconds:null,d=typeof n.averageSeconds=="number"?n.averageSeconds:null;u!==null&&u<p&&(p=u,r=!0),d!==null&&d<_&&(_=d,r=!0),r&&t.push({...n,isSingleRecord:u!==null&&u===p,isAverageRecord:d!==null&&d===_,nickname:n.nickname||m.getNicknameForUser(n.userId)||""})}),t.reverse(),t.slice((D.value-1)*U.value,D.value*U.value)}),Z=$(()=>{if(!b.value)return 0;const o=m.getRecordsByEvent(b.value);let t=1/0,p=1/0,_=0;return[...o].sort((n,r)=>{const u=n.timestamp?new Date(n.timestamp).getTime():0,d=r.timestamp?new Date(r.timestamp).getTime():0;return u-d}).forEach(n=>{let r=!1;const u=typeof n.singleSeconds=="number"?n.singleSeconds:null,d=typeof n.averageSeconds=="number"?n.averageSeconds:null;u!==null&&u<t&&(t=u,r=!0),d!==null&&d<p&&(p=d,r=!0),r&&_++}),_});P(b,()=>{D.value=1;const o=m.getRecordsByEvent(b.value);m.ensureNicknamesForRecords(o)});const F=o=>m.formatTime(o),L=o=>{if(!o)return"-";const t=new Date(o),p=t.getFullYear(),_=String(t.getMonth()+1).padStart(2,"0"),B=String(t.getDate()).padStart(2,"0");return`${p}.${_}.${B}`},ee=$(()=>re());return(o,t)=>{const p=y("el-button"),_=y("router-link"),B=y("el-alert"),n=y("el-option"),r=y("el-select"),u=y("el-option-group"),d=y("el-tag"),E=y("el-icon"),V=y("el-tooltip"),S=y("el-table-column"),C=y("el-table"),O=y("el-pagination"),G=de("loading");return s(),v("div",me,[i(H,{name:"fade",duration:600,appear:""},{default:a(()=>[l("div",_e,[l("div",fe,[t[6]||(t[6]=l("h1",{class:"page-title"},"记录统计",-1)),i(p,{circle:"",plain:"",size:"small",type:"info",onClick:J,loading:w.value,class:"refresh-icon-button"},{default:a(()=>[w.value?(s(),v("i",pe)):(s(),v("img",ge))]),_:1},8,["loading"])]),l("div",ye,[A(Y)?(s(),c(_,{key:0,to:"/submit-record"},{default:a(()=>[i(p,{type:"primary"},{default:a(()=>t[7]||(t[7]=[f("上传成绩")])),_:1})]),_:1})):k("",!0)])])]),_:1}),I.value?(s(),v("div",ke,[i(B,{title:"获取数据失败",type:"error",description:I.value,"show-icon":"",closable:"",onClose:t[0]||(t[0]=e=>I.value="")},null,8,["description"])])):k("",!0),i(H,{name:"slide-up",duration:600,delay:200,appear:""},{default:a(()=>[q((s(),v("div",be,[l("div",we,[t[8]||(t[8]=l("h2",{class:"section-title"},"最佳记录",-1)),l("div",he,[i(r,{modelValue:x.value,"onUpdate:modelValue":t[1]||(t[1]=e=>x.value=e),placeholder:"选择项目类型",class:"category-select glass-select"},{default:a(()=>[(s(!0),v(R,null,N(A(ue),e=>(s(),c(n,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),i(r,{modelValue:T.value,"onUpdate:modelValue":t[2]||(t[2]=e=>T.value=e),placeholder:"选择具体项目",class:"event-select glass-select",loading:w.value},{default:a(()=>[(s(!0),v(R,null,N(K.value,e=>(s(),c(u,{key:e.label,label:e.label},{default:a(()=>[(s(!0),v(R,null,N(e.options,h=>(s(),c(n,{key:h.value,label:h.label,value:h.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","loading"])])]),l("div",Re,[i(ve,{records:Q.value},null,8,["records"])])])),[[G,w.value]])]),_:1}),i(H,{name:"slide-up",duration:600,delay:400,appear:""},{default:a(()=>[q((s(),v("div",Se,[l("div",Te,[t[9]||(t[9]=l("h2",{class:"section-title"},"历史记录",-1)),l("div",Ie,[i(r,{modelValue:b.value,"onUpdate:modelValue":t[3]||(t[3]=e=>b.value=e),placeholder:"选择项目",class:"event-select glass-select"},{default:a(()=>[(s(!0),v(R,null,N(ee.value,e=>(s(),c(u,{key:e.label,label:e.label},{default:a(()=>[(s(!0),v(R,null,N(e.options,h=>(s(),c(n,{key:h.value,label:h.label,value:h.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])]),b.value?(s(),v("div",Be,[i(C,{data:X.value,style:{width:"100%"},stripe:!0,class:"custom-table glass-table"},{default:a(()=>[i(S,{type:"expand"},{default:a(e=>[l("div",Ee,[l("div",Ve,[t[11]||(t[11]=l("span",{class:"detail-label"},"单次成绩：",-1)),l("span",ze,[f(g(F(e.row.singleSeconds))+" ",1),e.row.isSingleRecord?(s(),c(d,{key:0,size:"small",type:"danger",effect:"dark"},{default:a(()=>t[10]||(t[10]=[f("GR")])),_:1})):k("",!0)])]),l("div",xe,[t[12]||(t[12]=l("span",{class:"detail-label"},"单次保持者：",-1)),l("span",Ae,[e.row.userId?(s(),c(_,{key:0,to:`/user/${e.row.userId}`,class:"player-link"},{default:a(()=>[f(g(e.row.nickname||"未知"),1)]),_:2},1032,["to"])):(s(),v(R,{key:1},[l("span",null,g(e.row.nickname||"-"),1),e.row.nickname?(s(),c(V,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:a(()=>[i(E,{class:"info-icon"},{default:a(()=>[i(A(M))]),_:1})]),_:1})):k("",!0)],64))])]),l("div",De,[t[14]||(t[14]=l("span",{class:"detail-label"},"平均成绩：",-1)),l("span",$e,[f(g(F(e.row.averageSeconds))+" ",1),e.row.isAverageRecord?(s(),c(d,{key:0,size:"small",type:"danger",effect:"dark"},{default:a(()=>t[13]||(t[13]=[f("GR")])),_:1})):k("",!0)])]),l("div",Ne,[t[15]||(t[15]=l("span",{class:"detail-label"},"平均保持者：",-1)),l("span",Ue,[e.row.userId?(s(),c(_,{key:0,to:`/user/${e.row.userId}`,class:"player-link"},{default:a(()=>[f(g(e.row.nickname||"未知"),1)]),_:2},1032,["to"])):(s(),v(R,{key:1},[l("span",null,g(e.row.nickname||"-"),1),e.row.nickname?(s(),c(V,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:a(()=>[i(E,{class:"info-icon"},{default:a(()=>[i(A(M))]),_:1})]),_:1})):k("",!0)],64))])]),l("div",Fe,[t[16]||(t[16]=l("span",{class:"detail-label"},"记录时间：",-1)),l("span",Ce,g(L(e.row.timestamp)),1)])])]),_:1}),i(S,{prop:"index",label:"序号","min-width":"60",type:"index",index:1}),i(S,{label:"单次","min-width":"160"},{default:a(e=>[l("div",Ge,[l("div",Me,[f(g(F(e.row.singleSeconds))+" ",1),e.row.isSingleRecord?(s(),c(d,{key:0,size:"small",type:"danger",effect:"dark"},{default:a(()=>t[17]||(t[17]=[f("GR")])),_:1})):k("",!0)]),l("div",Oe,[e.row.userId?(s(),c(_,{key:0,to:`/user/${e.row.userId}`,class:"player-link"},{default:a(()=>[f(g(e.row.nickname||"未知"),1)]),_:2},1032,["to"])):(s(),v(R,{key:1},[l("span",null,g(e.row.nickname||"-"),1),e.row.nickname?(s(),c(V,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:a(()=>[i(E,{class:"info-icon"},{default:a(()=>[i(A(M))]),_:1})]),_:1})):k("",!0)],64))])])]),_:1}),i(S,{label:"平均","min-width":"160"},{default:a(e=>[l("div",je,[l("div",He,[f(g(F(e.row.averageSeconds))+" ",1),e.row.isAverageRecord?(s(),c(d,{key:0,size:"small",type:"danger",effect:"dark"},{default:a(()=>t[18]||(t[18]=[f("GR")])),_:1})):k("",!0)]),l("div",Le,[e.row.userId?(s(),c(_,{key:0,to:`/user/${e.row.userId}`,class:"player-link"},{default:a(()=>[f(g(e.row.nickname||"未知"),1)]),_:2},1032,["to"])):(s(),v(R,{key:1},[l("span",null,g(e.row.nickname||"-"),1),e.row.nickname?(s(),c(V,{key:0,content:"该选手暂未注册账号",placement:"top"},{default:a(()=>[i(E,{class:"info-icon"},{default:a(()=>[i(A(M))]),_:1})]),_:1})):k("",!0)],64))])])]),_:1}),i(S,{prop:"timestamp",label:"时间","min-width":"120","class-name":"hide-on-mobile"},{default:a(e=>[f(g(L(e.row.timestamp)),1)]),_:1})]),_:1},8,["data"]),l("div",Pe,[i(O,{"current-page":D.value,"onUpdate:currentPage":t[4]||(t[4]=e=>D.value=e),"page-size":U.value,"onUpdate:pageSize":t[5]||(t[5]=e=>U.value=e),total:Z.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",class:"responsive-pagination"},null,8,["current-page","page-size","total"])])])):k("",!0)])),[[G,w.value]])]),_:1})])}}},Xe=ae(qe,[["__scopeId","data-v-0ce70987"]]);export{Xe as default};
