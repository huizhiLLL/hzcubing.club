import{_ as B,u as M,r as I,a as O,w as q,o as P,E as n,b as w,c as b,d as h,e as i,f,g as u,h as v,t as C,i as H,j as V,k as J,n as X}from"./index-Dk6zR9k4.js";import{E as j}from"./ElementTransition-B1nF07HC.js";const L={class:"profile-container"},G={class:"card profile-header glass-card"},K={class:"user-profile"},Q={class:"user-info"},Y={class:"nickname"},Z={class:"bio"},ee={key:0,class:"wca-id"},oe={class:"action-buttons"},ae={key:0,class:"glass-form"},le={key:1,class:"loading-text"},te={class:"dialog-footer"},se={__name:"ProfileView",setup(ne){const x=J(),c=M(),{user:e}=c;I(!1);const _=I(!1),S=I(),l=O({nickname:"",bio:"",wcaId:""}),T={nickname:[{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],bio:[{max:200,message:"签名不能超过200个字符",trigger:"blur"}],wcaId:[{max:20,message:"WCA ID 最多20字符",trigger:"blur"}]},U=async()=>{console.log("刷新用户信息"),await c.initUser(),e.value&&X(()=>{try{const r=document.querySelector(".nickname"),o=document.querySelector(".bio");r&&(r.textContent=e.value.nickname||""),o&&(o.textContent=e.value.bio||"这个人很懒，什么都没写~");let a=document.querySelector(".wca-id");e.value.wcaId?a?(a.textContent=`WCA ID: ${e.value.wcaId}`,a.style.display="block"):(a=document.createElement("p"),a.className="wca-id",a.textContent=`WCA ID: ${e.value.wcaId}`,o&&o.parentNode&&o.parentNode.insertBefore(a,o.nextSibling)):a&&(a.style.display="none"),console.log("页面更新完成")}catch(r){console.error("更新页面时出错:",r)}})},$=()=>{console.log("取消编辑"),_.value=!1},F=async()=>{S.value&&await S.value.validate(async r=>{if(r){const o=n({message:"正在更新资料...",type:"info",duration:0});try{if(!c.user){o.close(),n.error("请先登录"),x.push("/login");return}const a=localStorage.getItem("token");if(!a){o.close(),n.error("登录状态已过期，请重新登录"),x.push("/login");return}console.log("提交数据:",JSON.stringify(l)),console.log("当前用户状态:",JSON.stringify(c.user)),console.log("当前token:",a);const p=await c.updateProfile(l);console.log("更新结果:",p),o.close(),_.value=!1,n.success("个人资料更新成功"),await U()}catch(a){o.close(),console.error("资料更新失败:",a),a.message&&a.message.includes("登录")?(n.error("登录状态已过期，请重新登录"),localStorage.removeItem("token"),c.clearToken(),x.push("/login")):n.error(a.message||"更新失败，请重试")}}})};q(()=>c.user,r=>{r&&_.value&&(l.nickname=r.nickname||"",l.bio=r.bio||"",l.wcaId=r.wcaId||"",console.log("用户数据更新，重新设置表单数据:",l))},{deep:!0}),P(async()=>{console.log("ProfileView 组件挂载，初始用户状态:",e.value),console.log("localStorage token:",localStorage.getItem("token")),localStorage.getItem("token")&&!e.value&&(console.log("尝试重新初始化用户信息"),await c.initUser(),console.log("初始化后的用户状态:",e.value)),e.value&&(console.log("用户ID信息:",{id:e.value.id,_id:e.value._id,hasId:!!e.value.id,has_Id:!!e.value._id}),!e.value._id&&e.value.id&&(e.value._id=e.value.id,console.log("添加_id字段:",e.value._id)),!e.value.id&&e.value._id&&(e.value.id=e.value._id,console.log("添加id字段:",e.value.id))),localStorage.getItem("profile_message")==="edit_success"&&n.success("资料更新成功"),localStorage.removeItem("profile_message")});const R=()=>{e.value&&(l.nickname=e.value.nickname||"",l.bio=e.value.bio||"",l.wcaId=e.value.wcaId||"",console.log("预填充表单数据:",l)),_.value=!0},g=I(null),y=I(!1);I(null);const z=()=>{g.value.click()},A=async r=>{const o=r.target.files[0];if(!o){n.error("未选择文件");return}if(!o.type.startsWith("image/")){n.error("请选择图片文件");return}if(o.size>2*1024*1024){n.error("图片大小不能超过2MB");return}if(o.size===0){n.error("文件内容为空");return}console.log("选择的文件信息:",{name:o.name,type:o.type,size:o.size+" 字节",lastModified:new Date(o.lastModified).toLocaleString()}),y.value=!0;try{const a=new FormData;a.append("avatar",o),c.user&&c.user._id&&a.append("userId",c.user._id),console.log("FormData内容:");for(let[d,s]of a.entries())console.log(`${d}: ${s instanceof File?s.name:s}`);const p="https://w3mavh11ex.bja.sealos.run/upload-avatar";console.log("上传头像到:",p);const k=localStorage.getItem("token"),t=new XMLHttpRequest;t.open("POST",p,!0),k&&t.setRequestHeader("Authorization",`Bearer ${k}`),t.upload.onprogress=d=>{if(d.lengthComputable){const s=d.loaded/d.total*100;console.log(`上传进度: ${s.toFixed(2)}%`)}},t.onload=function(){var d;if(console.log(`XHR状态: ${t.status}`),console.log(`XHR响应: ${t.responseText}`),t.status>=200&&t.status<300)try{const s=JSON.parse(t.responseText);if(console.log("上传结果:",s),s.code===200&&((d=s.data)!=null&&d.avatarUrl))e.value&&(e.value.avatar=s.data.avatarUrl,localStorage.setItem("userInfo",JSON.stringify(e.value))),n.success("头像更新成功");else throw new Error(s.message||"上传失败")}catch(s){console.error("解析响应失败:",s),n.error("上传头像失败: "+s.message)}else console.error("上传失败:",t.status,t.statusText,t.responseText),n.error(`上传失败 (${t.status}): ${t.responseText||"未知错误"}`);y.value=!1,g.value&&(g.value.value="")},t.onerror=function(){console.error("网络错误"),n.error("网络错误，请检查网络连接"),y.value=!1,g.value&&(g.value.value="")},t.send(a)}catch(a){console.error("上传头像失败:",a),n.error(a.message||"上传头像失败，请重试"),y.value=!1,g.value&&(g.value.value="")}},W=()=>{console.log("对话框已打开，填充表单数据"),setTimeout(()=>{e.value?(l.nickname=e.value.nickname||"",l.bio=e.value.bio||"",l.wcaId=e.value.wcaId||"",console.log("表单数据已填充:",l)):(console.warn("用户数据不存在，无法填充表单"),c.initUser().then(()=>{e.value&&(l.nickname=e.value.nickname||"",l.bio=e.value.bio||"",l.wcaId=e.value.wcaId||"",console.log("重新获取用户数据后填充表单:",l))}))},100)};return(r,o)=>{const a=w("el-avatar"),p=w("el-button"),k=w("el-input"),t=w("el-form-item"),d=w("el-form"),s=w("el-dialog");return b(),h("div",L,[i(j,{name:"zoom",duration:600,appear:""},{default:f(()=>{var m,D,E,N;return[u("div",G,[u("div",K,[u("div",{class:"avatar-container",onClick:z},[i(a,{size:128,src:((m=v(e))==null?void 0:m.avatar)||"/default-avatar.svg",class:"avatar"},null,8,["src"]),o[4]||(o[4]=u("div",{class:"avatar-overlay"},[u("span",null,"更换头像")],-1)),u("input",{type:"file",ref_key:"fileInput",ref:g,style:{display:"none"},accept:"image/*",onChange:A},null,544)]),u("div",Q,[u("h1",Y,C((D=v(e))==null?void 0:D.nickname),1),u("p",Z,C(((E=v(e))==null?void 0:E.bio)||"这个人很懒，什么都没写~"),1),(N=v(e))!=null&&N.wcaId?(b(),h("p",ee,"WCA ID: "+C(v(e).wcaId),1)):H("",!0),u("div",oe,[i(p,{type:"primary",onClick:R},{default:f(()=>o[5]||(o[5]=[V(" 编辑资料 ")])),_:1})])])])])]}),_:1}),i(s,{modelValue:_.value,"onUpdate:modelValue":o[3]||(o[3]=m=>_.value=m),title:"编辑资料",width:"500px","destroy-on-close":!1,"close-on-click-modal":!1,onOpen:W,class:"glass-dialog"},{footer:f(()=>[u("span",te,[i(p,{onClick:$},{default:f(()=>o[6]||(o[6]=[V("取消")])),_:1}),i(p,{type:"primary",onClick:F,disabled:!v(e)},{default:f(()=>o[7]||(o[7]=[V(" 确定 ")])),_:1},8,["disabled"])])]),default:f(()=>[v(e)?(b(),h("div",ae,[i(d,{ref_key:"editFormRef",ref:S,model:l,rules:T,"label-width":"80px"},{default:f(()=>[i(t,{label:"昵称",prop:"nickname"},{default:f(()=>[i(k,{modelValue:l.nickname,"onUpdate:modelValue":o[0]||(o[0]=m=>l.nickname=m),placeholder:"请输入昵称"},null,8,["modelValue"])]),_:1}),i(t,{label:"签名",prop:"bio"},{default:f(()=>[i(k,{modelValue:l.bio,"onUpdate:modelValue":o[1]||(o[1]=m=>l.bio=m),type:"textarea",rows:3,placeholder:"请输入个人签名"},null,8,["modelValue"])]),_:1}),i(t,{label:"WCA ID",prop:"wcaId"},{default:f(()=>[i(k,{modelValue:l.wcaId,"onUpdate:modelValue":o[2]||(o[2]=m=>l.wcaId=m),placeholder:"如有请填写"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])):(b(),h("div",le," 加载用户数据中... "))]),_:1},8,["modelValue"])])}}},ce=B(se,[["__scopeId","data-v-3b7a5554"]]);export{ce as default};
