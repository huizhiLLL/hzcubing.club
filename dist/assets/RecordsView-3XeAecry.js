import{_ as re}from"./refresh-DSDc0Cm4.js";import{_ as le,l as ae,u as oe,r as w,m as I,o as ne,E as j,b as h,p as ie,c as a,d as i,q as K,s as B,f as r,e as d,j as D,t as u,h as q,i as b,g as e,w as se,F as M,v as O}from"./index-Dk6zR9k4.js";import{g as te,e as G,a as de,c as ue}from"./events-CUXDbKN2.js";import{E as J}from"./ElementTransition-B1nF07HC.js";const ce={class:"table-container"},ve={key:0,class:"record-value"},_e={key:0,class:"rank"},me={key:1},pe={key:0,class:"record-value"},fe={key:0,class:"rank"},ge={key:1},be={key:0,class:"record-details glass-form"},he={class:"detail-item"},ye={class:"value"},ke={class:"detail-item"},we={class:"value"},$e={key:0,class:"detail-item"},Re={class:"value"},Ve={key:1,class:"detail-item"},De={class:"value"},Ee={key:2,class:"detail-item"},xe={class:"value"},Se={class:"detail-item"},Ce={class:"value"},Be={key:3,class:"detail-item"},Ue={class:"value"},ze={key:4,class:"detail-item"},Ie={class:"value"},Ne={key:5,class:"detail-item"},Te=["href"],Le={key:6,class:"detail-item"},Fe={class:"value"},Me={key:7,class:"actions"},Oe={class:"dialog-footer"},je={__name:"RecordsTable",props:{records:{type:Array,default:()=>[]},showActions:{type:Boolean,default:!0},autoRefresh:{type:Boolean,default:!0},isDebug:{type:Boolean,default:!1}},emits:["refresh","delete"],setup(Q,{emit:H}){const $=Q,N=H,R=ae(),y=oe(),k=w(!1),E=w(!1),x=w(!1),m=w(!1),o=w(null),A=n=>{var s,_;return n.cube||((s=n.single)==null?void 0:s.cube)||((_=n.average)==null?void 0:_.cube)||""},P=n=>{var s,_;return n.method||((s=n.single)==null?void 0:s.method)||((_=n.average)==null?void 0:_.method)||""},T=n=>n!=null&&n!=="null"&&n!=="",U=n=>R.formatTime(n),W=(n,s=!1)=>{if(!n)return"-";const _=new Date(n);if(isNaN(_))return"-";const p={year:"numeric",month:"2-digit",day:"2-digit"};return s&&(p.hour="2-digit",p.minute="2-digit"),_.toLocaleDateString("zh-CN",p)},z=I(()=>$.records),L=async()=>{if($.autoRefresh){k.value=!0;try{await R.fetchRecords(),N("refresh")}catch{j.error("刷新数据失败")}finally{k.value=!1}}else N("refresh")},Y=n=>{var p,V;if(!y.user||!n)return!1;if(n.userId)return n.userId===y.user._id;const s=(p=n.single)==null?void 0:p.userId,_=(V=n.average)==null?void 0:V.userId;return s&&s===y.user._id||_&&_===y.user._id},v=()=>{m.value=!0},t=async()=>{if(!o.value||!o.value._id){j.error("无法删除，记录ID不存在"),m.value=!1;return}E.value=!0;try{await R.deleteRecord(o.value._id),j.success("记录已删除"),m.value=!1,x.value=!1,N("delete",o.value._id),L()}catch(n){j.error("删除失败: "+n.message)}finally{E.value=!1}};return ne(()=>{$.autoRefresh&&L()}),(n,s)=>{const _=h("el-table-column"),p=h("el-table"),V=h("el-button"),F=h("el-dialog"),C=ie("loading");return a(),i("div",ce,[K((a(),B(p,{data:z.value,style:{width:"100%"},stripe:!0,class:"records-table glass-table"},{default:r(()=>[d(_,{label:"项目","min-width":"100"},{default:r(c=>[D(u(q(te)(c.row.event)),1)]),_:1}),d(_,{label:"昵称","min-width":"120"},{default:r(c=>{var f;return[D(u(((f=c.row.single)==null?void 0:f.nickname)||"-"),1)]}),_:1}),d(_,{label:"单次","min-width":"100"},{default:r(c=>{var f;return[((f=c.row.single)==null?void 0:f.time)!==void 0?(a(),i("span",ve,[D(u(U(c.row.single.time))+" ",1),c.row.singleRank?(a(),i("span",_e,"(#"+u(c.row.singleRank)+")",1)):b("",!0)])):(a(),i("span",me,"-"))]}),_:1}),d(_,{label:"平均","min-width":"100"},{default:r(c=>{var f;return[((f=c.row.average)==null?void 0:f.time)!==void 0?(a(),i("span",pe,[D(u(U(c.row.average.time))+" ",1),c.row.averageRank?(a(),i("span",fe,"(#"+u(c.row.averageRank)+")",1)):b("",!0)])):(a(),i("span",ge,"-"))]}),_:1}),d(_,{label:"昵称","min-width":"120"},{default:r(c=>{var f;return[D(u(((f=c.row.average)==null?void 0:f.nickname)||"-"),1)]}),_:1})]),_:1},8,["data"])),[[C,k.value]]),d(F,{modelValue:x.value,"onUpdate:modelValue":s[0]||(s[0]=c=>x.value=c),title:"成绩详情",width:"500px",class:"glass-dialog"},{default:r(()=>{var c,f;return[o.value?(a(),i("div",be,[e("div",he,[s[3]||(s[3]=e("span",{class:"label"},"项目:",-1)),e("span",ye,u(q(te)(o.value.event)),1)]),e("div",ke,[s[4]||(s[4]=e("span",{class:"label"},"单次成绩:",-1)),e("span",we,u((c=o.value.single)!=null&&c.time?U(o.value.single.time):"-"),1)]),o.value.single?(a(),i("div",$e,[s[5]||(s[5]=e("span",{class:"label"},"单次保持者:",-1)),e("span",Re,u(o.value.single.nickname||"-"),1)])):b("",!0),T(A(o.value))?(a(),i("div",Ve,[s[6]||(s[6]=e("span",{class:"label"},"使用魔方:",-1)),e("span",De,u(A(o.value)),1)])):b("",!0),T(P(o.value))?(a(),i("div",Ee,[s[7]||(s[7]=e("span",{class:"label"},"使用方法:",-1)),e("span",xe,u(P(o.value)),1)])):b("",!0),e("div",Se,[s[8]||(s[8]=e("span",{class:"label"},"平均成绩:",-1)),e("span",Ce,u((f=o.value.average)!=null&&f.time?U(o.value.average.time):"-"),1)]),o.value.average?(a(),i("div",Be,[s[9]||(s[9]=e("span",{class:"label"},"平均保持者:",-1)),e("span",Ue,u(o.value.average.nickname||"-"),1)])):b("",!0),T(o.value.remark)?(a(),i("div",ze,[s[10]||(s[10]=e("span",{class:"label"},"备注:",-1)),e("span",Ie,u(o.value.remark),1)])):b("",!0),o.value.videoLink?(a(),i("div",Ne,[s[11]||(s[11]=e("span",{class:"label"},"视频链接:",-1)),e("a",{href:o.value.videoLink,target:"_blank",class:"video-link"},u(o.value.videoLink),9,Te)])):b("",!0),o.value.timestamp?(a(),i("div",Le,[s[12]||(s[12]=e("span",{class:"label"},"提交时间:",-1)),e("span",Fe,u(W(o.value.timestamp,!0)),1)])):b("",!0),Y(o.value)?(a(),i("div",Me,[d(V,{type:"danger",size:"small",onClick:v},{default:r(()=>s[13]||(s[13]=[D("删除")])),_:1})])):b("",!0)])):b("",!0)]}),_:1},8,["modelValue"]),d(F,{modelValue:m.value,"onUpdate:modelValue":s[2]||(s[2]=c=>m.value=c),title:"确认删除",width:"300px",class:"glass-dialog"},{footer:r(()=>[e("span",Oe,[d(V,{onClick:s[1]||(s[1]=c=>m.value=!1)},{default:r(()=>s[14]||(s[14]=[D("取消")])),_:1}),d(V,{type:"danger",onClick:t,loading:E.value},{default:r(()=>s[15]||(s[15]=[D("确定")])),_:1},8,["loading"])])]),default:r(()=>[s[16]||(s[16]=e("p",null,"确定要删除这条成绩记录吗？此操作不可恢复。",-1))]),_:1},8,["modelValue"])])}}},Ae=le(je,[["__scopeId","data-v-1f7a3aeb"]]),Pe={class:"records-container"},qe={class:"page-header glass-header"},He={class:"title-with-refresh"},We={key:0,src:re,alt:"刷新",class:"refresh-icon"},Ye={key:1,class:"el-icon-loading"},Ge={class:"header-actions"},Je={key:0,class:"error-alert"},Ke={class:"card glass-card"},Qe={class:"filter-header"},Xe={class:"filter-controls"},Ze={class:"table-responsive"},es={class:"card glass-card"},ss={class:"filter-header"},ts={class:"filter-controls"},ls={key:0,class:"table-responsive"},as={class:"record-details"},os={class:"detail-item"},ns={class:"detail-value"},is={class:"detail-item"},rs={class:"detail-value"},ds={class:"detail-item"},us={class:"detail-value"},cs={class:"detail-item"},vs={class:"detail-value"},_s={class:"detail-item"},ms={class:"detail-value"},ps={class:"record-cell"},fs={class:"record-main"},gs={class:"record-sub"},bs={class:"record-cell"},hs={class:"record-main"},ys={class:"record-sub"},ks={class:"pagination"},ws={__name:"RecordsView",setup(Q){const H=oe(),$=ae(),{user:N}=H,R=w("official"),y=w("official_all"),k=w(""),E=w(1),x=w(10),m=w(!1),o=w(""),A=async()=>{m.value=!0,o.value="";try{await $.fetchRecords(),j.success("数据刷新成功")}catch(v){console.error("刷新记录失败:",v),o.value=v.message||"获取数据失败，请稍后再试"}finally{m.value=!1}};ne(async()=>{m.value=!0,o.value="";try{await $.fetchRecords()}catch(v){console.error("获取记录失败:",v),o.value=v.message||"获取数据失败，请稍后再试"}finally{m.value=!1}});const P=I(()=>R.value==="all"?[G.all]:R.value?[G[R.value]]:[]);se(R,v=>{y.value=v?`${v}_all`:""});const T=I(()=>{var t;const v=$.getBestRecords();if(y.value==="all_all")return Object.values(v);if(y.value.endsWith("_all")){const n=y.value.split("_")[0],_=(((t=G[n])==null?void 0:t.options)||[]).slice(1).map(p=>p.value);return Object.values(v).filter(p=>_.includes(p.event))}return[v[y.value]].filter(Boolean)}),U=I(()=>k.value?$.getRecordsByEvent(k.value).sort((t,n)=>new Date(n.timestamp)-new Date(t.timestamp)).slice((E.value-1)*x.value,E.value*x.value):[]),W=I(()=>k.value?$.getRecordsByEvent(k.value).length:0);se(k,()=>{E.value=1});const z=v=>$.formatTime(v),L=v=>{if(!v)return"-";const t=new Date(v);return`${t.getFullYear()}年${String(t.getMonth()+1).padStart(2,"0")}月${String(t.getDate()).padStart(2,"0")}日`},Y=I(()=>de());return(v,t)=>{const n=h("el-button"),s=h("router-link"),_=h("el-alert"),p=h("el-option"),V=h("el-select"),F=h("el-option-group"),C=h("el-table-column"),c=h("el-table"),f=h("el-pagination"),X=ie("loading");return a(),i("div",Pe,[d(J,{name:"fade",duration:600,appear:""},{default:r(()=>[e("div",qe,[e("div",He,[t[6]||(t[6]=e("h1",{class:"page-title"},"记录统计",-1)),d(n,{circle:"",plain:"",size:"small",type:"info",onClick:A,loading:m.value,class:"refresh-icon-button"},{default:r(()=>[m.value?(a(),i("i",Ye)):(a(),i("img",We))]),_:1},8,["loading"])]),e("div",Ge,[q(N)?(a(),B(s,{key:0,to:"/submit-record"},{default:r(()=>[d(n,{type:"primary"},{default:r(()=>t[7]||(t[7]=[D("上传成绩")])),_:1})]),_:1})):b("",!0)])])]),_:1}),o.value?(a(),i("div",Je,[d(_,{title:"获取数据失败",type:"error",description:o.value,"show-icon":"",closable:"",onClose:t[0]||(t[0]=l=>o.value="")},null,8,["description"])])):b("",!0),d(J,{name:"slide-up",duration:600,delay:200,appear:""},{default:r(()=>[K((a(),i("div",Ke,[e("div",Qe,[t[8]||(t[8]=e("h2",{class:"section-title"},"最佳记录",-1)),e("div",Xe,[d(V,{modelValue:R.value,"onUpdate:modelValue":t[1]||(t[1]=l=>R.value=l),placeholder:"选择项目类型",class:"category-select glass-select"},{default:r(()=>[(a(!0),i(M,null,O(q(ue),l=>(a(),B(p,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),d(V,{modelValue:y.value,"onUpdate:modelValue":t[2]||(t[2]=l=>y.value=l),placeholder:"选择具体项目",class:"event-select glass-select",loading:m.value},{default:r(()=>[(a(!0),i(M,null,O(P.value,l=>(a(),B(F,{key:l.label,label:l.label},{default:r(()=>[(a(!0),i(M,null,O(l.options,g=>(a(),B(p,{key:g.value,label:g.label,value:g.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","loading"])])]),e("div",Ze,[d(Ae,{records:T.value},null,8,["records"])])])),[[X,m.value]])]),_:1}),d(J,{name:"slide-up",duration:600,delay:400,appear:""},{default:r(()=>[K((a(),i("div",es,[e("div",ss,[t[9]||(t[9]=e("h2",{class:"section-title"},"历史记录",-1)),e("div",ts,[d(V,{modelValue:k.value,"onUpdate:modelValue":t[3]||(t[3]=l=>k.value=l),placeholder:"选择项目",class:"event-select glass-select"},{default:r(()=>[(a(!0),i(M,null,O(Y.value,l=>(a(),B(F,{key:l.label,label:l.label},{default:r(()=>[(a(!0),i(M,null,O(l.options,g=>(a(),B(p,{key:g.value,label:g.label,value:g.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])]),k.value?(a(),i("div",ls,[d(c,{data:U.value,style:{width:"100%"},stripe:!0,class:"custom-table glass-table"},{default:r(()=>[d(C,{type:"expand"},{default:r(l=>{var g,S,Z,ee;return[e("div",as,[e("div",os,[t[10]||(t[10]=e("span",{class:"detail-label"},"单次成绩：",-1)),e("span",ns,u(z((g=l.row.single)==null?void 0:g.time)),1)]),e("div",is,[t[11]||(t[11]=e("span",{class:"detail-label"},"单次保持者：",-1)),e("span",rs,u(((S=l.row.single)==null?void 0:S.nickname)||"-"),1)]),e("div",ds,[t[12]||(t[12]=e("span",{class:"detail-label"},"平均成绩：",-1)),e("span",us,u(z((Z=l.row.average)==null?void 0:Z.time)),1)]),e("div",cs,[t[13]||(t[13]=e("span",{class:"detail-label"},"平均保持者：",-1)),e("span",vs,u(((ee=l.row.average)==null?void 0:ee.nickname)||"-"),1)]),e("div",_s,[t[14]||(t[14]=e("span",{class:"detail-label"},"记录时间：",-1)),e("span",ms,u(L(l.row.timestamp)),1)])])]}),_:1}),d(C,{prop:"index",label:"序号","min-width":"60",type:"index",index:1}),d(C,{label:"单次","min-width":"160"},{default:r(l=>{var g,S;return[e("div",ps,[e("div",fs,u(z((g=l.row.single)==null?void 0:g.time)),1),e("div",gs,u(((S=l.row.single)==null?void 0:S.nickname)||"-"),1)])]}),_:1}),d(C,{label:"平均","min-width":"160"},{default:r(l=>{var g,S;return[e("div",bs,[e("div",hs,u(z((g=l.row.average)==null?void 0:g.time)),1),e("div",ys,u(((S=l.row.average)==null?void 0:S.nickname)||"-"),1)])]}),_:1}),d(C,{prop:"timestamp",label:"时间","min-width":"120","class-name":"hide-on-mobile"},{default:r(l=>[D(u(L(l.row.timestamp)),1)]),_:1})]),_:1},8,["data"]),e("div",ks,[d(f,{"current-page":E.value,"onUpdate:currentPage":t[4]||(t[4]=l=>E.value=l),"page-size":x.value,"onUpdate:pageSize":t[5]||(t[5]=l=>x.value=l),total:W.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",class:"responsive-pagination"},null,8,["current-page","page-size","total"])])])):b("",!0)])),[[X,m.value]])]),_:1})])}}},Es=le(ws,[["__scopeId","data-v-d62c40ea"]]);export{Es as default};
